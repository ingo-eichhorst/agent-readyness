---
phase: 01-foundation
plan: 02
type: tdd
wave: 2
depends_on: ["01-01"]
files_modified:
  - internal/discovery/walker.go
  - internal/discovery/classifier.go
  - internal/discovery/walker_test.go
  - internal/discovery/classifier_test.go
  - testdata/valid-go-project/go.mod
  - testdata/valid-go-project/main.go
  - testdata/valid-go-project/main_test.go
  - testdata/valid-go-project/doc_generated.go
  - testdata/valid-go-project/util_linux.go
  - testdata/valid-go-project/vendor/dep/dep.go
  - testdata/valid-go-project/.gitignore
  - testdata/valid-go-project/ignored_by_gitignore.go
  - testdata/non-go-project/readme.txt

autonomous: true

must_haves:
  truths:
    - "Walker discovers all .go files under a directory tree recursively"
    - "Test files (_test.go) are classified as ClassTest"
    - "Generated files (containing Code generated DO NOT EDIT header) are classified as ClassGenerated"
    - "Files in vendor/ directories are classified as ClassExcluded with reason 'vendor'"
    - "Files matching .gitignore patterns are classified as ClassExcluded with reason 'gitignore'"
    - "Hidden directories (.git, .idea) are skipped entirely"
    - "ScanResult counts match the actual file classifications"
  artifacts:
    - path: "internal/discovery/classifier.go"
      provides: "File classification logic: ClassifyGoFile, IsGeneratedFile"
      exports: ["ClassifyGoFile", "IsGeneratedFile"]
    - path: "internal/discovery/walker.go"
      provides: "Directory walker with gitignore, vendor exclusion, symlink support"
      exports: ["Walker", "Discover"]
    - path: "internal/discovery/classifier_test.go"
      provides: "TDD tests for file classification"
      contains: "TestClassifyGoFile"
    - path: "internal/discovery/walker_test.go"
      provides: "TDD tests for directory walking"
      contains: "TestDiscover"
    - path: "testdata/valid-go-project/"
      provides: "Test fixture with go.mod, source, test, generated, vendor, gitignore files"
  key_links:
    - from: "internal/discovery/walker.go"
      to: "internal/discovery/classifier.go"
      via: "Walker calls ClassifyGoFile and IsGeneratedFile for each .go file"
      pattern: "ClassifyGoFile|IsGeneratedFile"
    - from: "internal/discovery/walker.go"
      to: "pkg/types/types.go"
      via: "Returns []types.DiscoveredFile"
      pattern: "types\\.DiscoveredFile"
    - from: "internal/discovery/walker.go"
      to: "sabhiram/go-gitignore"
      via: "Loads and matches .gitignore patterns"
      pattern: "ignore\\.CompileIgnoreFile"
---

<objective>
Build the file discovery engine and Go file classifier using TDD. The walker traverses directories, skips vendor/hidden/.gitignored paths, and classifies each .go file by type. This is the core data-gathering layer that all analysis depends on.

Purpose: Accurate file discovery and classification is the foundation of every metric. Wrong classification means wrong scores.
Output: Tested walker and classifier that produce correct DiscoveredFile lists with proper classifications.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-CONTEXT.md
@.planning/phases/01-foundation/01-RESEARCH.md
@.planning/phases/01-foundation/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: TDD file classifier</name>
  <files>
    internal/discovery/classifier.go
    internal/discovery/classifier_test.go
    testdata/valid-go-project/go.mod
    testdata/valid-go-project/main.go
    testdata/valid-go-project/main_test.go
    testdata/valid-go-project/doc_generated.go
    testdata/valid-go-project/util_linux.go
    testdata/valid-go-project/vendor/dep/dep.go
    testdata/valid-go-project/.gitignore
    testdata/valid-go-project/ignored_by_gitignore.go
    testdata/non-go-project/readme.txt
  </files>
  <action>
    **RED phase -- write tests first:**

    Create `internal/discovery/classifier_test.go` with these test cases:

    `TestClassifyGoFile`:
    - "main.go" -> ClassSource
    - "handler.go" -> ClassSource
    - "main_test.go" -> ClassTest
    - "handler_test.go" -> ClassTest
    - "_ignored.go" -> ClassExcluded (Go convention: underscore prefix ignored)
    - ".hidden.go" -> ClassExcluded (dot prefix ignored)

    `TestIsGeneratedFile`:
    - File with `// Code generated by protoc-gen-go. DO NOT EDIT.` on first line -> true
    - File with copyright header THEN `// Code generated by stringer. DO NOT EDIT.` before package -> true (Pitfall #2 from research)
    - Regular Go source file -> false
    - File with "DO NOT EDIT" in a comment AFTER package declaration -> false

    Create test fixtures in `testdata/`:
    - `testdata/valid-go-project/go.mod` -- minimal go.mod with module path
    - `testdata/valid-go-project/main.go` -- simple package main
    - `testdata/valid-go-project/main_test.go` -- simple test file
    - `testdata/valid-go-project/doc_generated.go` -- has generated header after copyright comment
    - `testdata/valid-go-project/util_linux.go` -- platform-specific file (regular source for classification)
    - `testdata/valid-go-project/vendor/dep/dep.go` -- vendor file
    - `testdata/valid-go-project/.gitignore` -- contains "ignored_by_gitignore.go"
    - `testdata/valid-go-project/ignored_by_gitignore.go` -- exists but should be gitignored
    - `testdata/non-go-project/readme.txt` -- not a Go project

    Run tests -- they MUST fail (functions don't exist yet).

    **GREEN phase -- implement classifier:**

    Create `internal/discovery/classifier.go` (package discovery):

    `ClassifyGoFile(name string) types.FileClass`:
    - If `strings.HasSuffix(name, "_test.go")` -> ClassTest
    - If `strings.HasPrefix(name, "_")` or `strings.HasPrefix(name, ".")` -> ClassExcluded
    - Otherwise -> ClassSource

    `IsGeneratedFile(path string) (bool, error)`:
    - Open file, scan line by line with bufio.Scanner
    - Stop scanning at `package ` declaration (generated comment MUST appear before it)
    - Match each line against `regexp.MustCompile("^// Code generated .* DO NOT EDIT\\.$")`
    - Return true on first match, false if package declaration reached without match
    - Use `var generatedPattern = regexp.MustCompile(...)` at package level (compile once)

    Run tests -- they MUST pass.

    Install gitignore dependency: `go get github.com/sabhiram/go-gitignore@latest`
  </action>
  <verify>
    `go test ./internal/discovery/ -run TestClassify -v` -- all classification tests pass.
    `go test ./internal/discovery/ -run TestIsGenerated -v` -- all generated detection tests pass.
    `go vet ./internal/discovery/` -- no issues.
  </verify>
  <done>
    ClassifyGoFile correctly classifies source, test, and excluded files. IsGeneratedFile detects generated headers even after copyright comments. All tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: TDD directory walker with exclusions</name>
  <files>
    internal/discovery/walker.go
    internal/discovery/walker_test.go
  </files>
  <action>
    **RED phase -- write tests first:**

    Create `internal/discovery/walker_test.go` with these test cases using the testdata fixtures from Task 1:

    `TestDiscoverValidProject`:
    - Walk `testdata/valid-go-project/`
    - Assert: main.go is ClassSource
    - Assert: main_test.go is ClassTest
    - Assert: doc_generated.go is ClassGenerated (walker calls IsGeneratedFile)
    - Assert: vendor/dep/dep.go is ClassExcluded with ExcludeReason "vendor"
    - Assert: ignored_by_gitignore.go is ClassExcluded with ExcludeReason "gitignore"
    - Assert: .git/ directory contents are NOT in results at all (skipped, not classified)
    - Assert: TotalFiles, SourceCount, TestCount, GeneratedCount, VendorCount, GitignoreCount are correct

    `TestDiscoverEmptyDir`:
    - Walk an empty temp directory
    - Assert: returns empty file list, zero counts

    `TestDiscoverNonExistentDir`:
    - Walk "/nonexistent/path"
    - Assert: returns error

    Run tests -- they MUST fail.

    **GREEN phase -- implement walker:**

    Create `internal/discovery/walker.go` (package discovery):

    `type Walker struct{}` with `func NewWalker() *Walker`

    `func (w *Walker) Discover(rootDir string) (*types.ScanResult, error)`:
    1. Validate rootDir exists and is a directory
    2. Load `.gitignore` from rootDir if present using `ignore.CompileIgnoreFile`
       - Per research Pitfall #3: only support root-level .gitignore in Phase 1
    3. Define skipDirs map: "vendor", ".git", "node_modules", "testdata" -- WAIT, do NOT skip testdata here. The testdata exclusion is for the scanned project's testdata. Actually per research, Go tooling ignores testdata/. But for our testdata fixtures to work, the walker must skip testdata/ at any depth. However, our test fixtures are in OUR testdata/ not the scanned project's. The walker receives an arbitrary rootDir. If rootDir is `testdata/valid-go-project/`, there is no testdata/ inside it to skip. So skip testdata/ directories encountered DURING the walk (matching Go tool behavior). Skip: "vendor", ".git", "node_modules", "testdata".
    4. Also skip any directory starting with "." (hidden dirs)
    5. `filepath.WalkDir(rootDir, func(path, d, err))`:
       - On err: return err immediately (per CONTEXT.md: fail on permission errors)
       - If dir and in skipDirs or hidden: return fs.SkipDir
       - If not .go file: return nil (skip non-Go files)
       - Compute relPath via filepath.Rel(rootDir, path)
       - Check gitignore: if matched, append as ClassExcluded with reason "gitignore"
       - Check if in vendor path (could be nested): check if relPath contains "vendor/" -- actually the SkipDir handles vendor/ dirs. But a file could be at `some/vendor/file.go` if "some" is not skipped. The skipDirs only catches dirs NAMED "vendor". That's correct -- vendor/ at any depth gets skipped.
       - Call IsGeneratedFile(path): if true, append as ClassGenerated
       - Otherwise call ClassifyGoFile(d.Name()): append with returned class
    6. Build ScanResult from accumulated files:
       - Count each class into the appropriate field
       - Set RootDir, TotalFiles, Files

    Run tests -- they MUST pass.

    **REFACTOR if needed:** Clean up, ensure error handling is consistent.
  </action>
  <verify>
    `go test ./internal/discovery/ -v` -- ALL tests pass (classifier + walker).
    `go test ./internal/discovery/ -count=1` -- no flaky tests.
    `go vet ./internal/discovery/` -- no issues.
  </verify>
  <done>
    Walker discovers all .go files recursively. Vendor dirs skipped. Hidden dirs skipped. Gitignored files marked as excluded. Generated files detected. ScanResult counts are accurate. All tests pass.
  </done>
</task>

</tasks>

<verification>
1. `go test ./internal/discovery/ -v` -- all tests pass
2. `go test ./internal/discovery/ -cover` -- coverage > 80% for classifier and walker
3. `go vet ./...` -- no issues
4. `go build ./...` -- everything compiles
</verification>

<success_criteria>
- Classifier correctly identifies source, test, generated, and excluded files
- Walker traverses directories, skips vendor/hidden/gitignored, classifies all .go files
- Generated file detection works even with copyright headers before the generated comment
- All tests pass with no flaky behavior
- ScanResult counts are mathematically consistent with file classifications
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-02-SUMMARY.md`
</output>
