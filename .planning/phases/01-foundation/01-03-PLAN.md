---
phase: 01-foundation
plan: 03
type: execute
wave: 3
depends_on: ["01-01", "01-02"]
files_modified:
  - internal/pipeline/interfaces.go
  - internal/pipeline/pipeline.go
  - internal/pipeline/pipeline_test.go
  - internal/output/terminal.go
  - internal/output/terminal_test.go
  - cmd/scan.go

autonomous: false

must_haves:
  truths:
    - "Running `ars scan .` on this repository prints a colored summary with file counts"
    - "Running `ars scan . --verbose` lists each discovered file with its classification"
    - "Running `ars scan . | cat` produces plain text without ANSI color codes"
    - "The pipeline processes files through discover -> parse (stub) -> analyze (stub) -> output stages"
    - "Running `ars scan <dir>` on a non-Go directory prints an actionable error and exits 1"
  artifacts:
    - path: "internal/pipeline/interfaces.go"
      provides: "Parser and Analyzer interfaces for Phase 2 extension"
      exports: ["Parser", "Analyzer", "StubParser", "StubAnalyzer"]
    - path: "internal/pipeline/pipeline.go"
      provides: "Pipeline orchestrator wiring discover -> parse -> analyze -> output"
      exports: ["Pipeline", "Run"]
    - path: "internal/output/terminal.go"
      provides: "TTY-aware colored terminal output"
      exports: ["RenderSummary"]
    - path: "cmd/scan.go"
      provides: "Updated scan command wired to real pipeline"
      contains: "pipeline.New"
  key_links:
    - from: "cmd/scan.go"
      to: "internal/pipeline/pipeline.go"
      via: "Creates pipeline and calls Run(dir)"
      pattern: "pipeline\\.New|pipeline\\.Run"
    - from: "internal/pipeline/pipeline.go"
      to: "internal/discovery/walker.go"
      via: "Calls walker.Discover(dir)"
      pattern: "discovery\\.NewWalker|walker\\.Discover"
    - from: "internal/pipeline/pipeline.go"
      to: "internal/output/terminal.go"
      via: "Calls output.RenderSummary with ScanResult"
      pattern: "output\\.RenderSummary"
    - from: "internal/output/terminal.go"
      to: "fatih/color"
      via: "Uses color.New for TTY-aware ANSI output"
      pattern: "color\\.New"
---

<objective>
Build the pipeline architecture (discover -> parse stub -> analyze stub -> output), create TTY-aware colored terminal output, and wire everything into the scan command so `ars scan <dir>` produces a real file discovery report.

Purpose: Completes the Phase 1 deliverable -- a working CLI that scans Go projects and reports what it finds. Also establishes the pipeline interfaces that Phase 2 plugs real analyzers into.
Output: A fully functional `ars scan <directory>` command that discovers, classifies, and reports Go files with colored output.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-CONTEXT.md
@.planning/phases/01-foundation/01-RESEARCH.md
@.planning/phases/01-foundation/01-01-SUMMARY.md
@.planning/phases/01-foundation/01-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Pipeline architecture with stub stages and terminal output</name>
  <files>
    internal/pipeline/interfaces.go
    internal/pipeline/pipeline.go
    internal/pipeline/pipeline_test.go
    internal/output/terminal.go
    internal/output/terminal_test.go
  </files>
  <action>
    1. Create `internal/pipeline/interfaces.go` (package pipeline):
       - `type Parser interface { Parse(files []types.DiscoveredFile) ([]types.ParsedFile, error) }`
       - `type Analyzer interface { Name() string; Analyze(files []types.ParsedFile) (*types.AnalysisResult, error) }`
       - `type StubParser struct{}`
         - `Parse()` converts DiscoveredFile slice to ParsedFile slice (copies Path, RelPath, Class)
       - `type StubAnalyzer struct{}`
         - `Name()` returns "stub"
         - `Analyze()` returns empty AnalysisResult with Name "stub"

    2. Create `internal/pipeline/pipeline.go` (package pipeline):
       - `type Pipeline struct { verbose bool; writer io.Writer; parser Parser; analyzers []Analyzer }`
       - `func New(w io.Writer, verbose bool) *Pipeline` -- creates pipeline with StubParser and StubAnalyzer
       - `func (p *Pipeline) Run(dir string) error`:
         a. Create discovery.NewWalker()
         b. Call walker.Discover(dir) -> ScanResult
         c. Call p.parser.Parse(result.Files) -> ParsedFiles (stub passthrough)
         d. For each analyzer, call analyzer.Analyze(parsedFiles) -> AnalysisResult (stub, ignored in Phase 1)
         e. Call output.RenderSummary(p.writer, result, p.verbose)
         f. Return nil (or error from any stage)

    3. Create `internal/pipeline/pipeline_test.go`:
       - `TestPipelineRun`: Run pipeline on `testdata/valid-go-project/`, capture output to bytes.Buffer, assert output contains "Source files:" and correct count
       - `TestStubParserPassthrough`: Verify StubParser preserves file count and paths

    4. Install color dependency: `go get github.com/fatih/color@v1.18.0`

    5. Create `internal/output/terminal.go` (package output):
       - `func RenderSummary(w io.Writer, result *types.ScanResult, verbose bool)`:
         a. Use `fatih/color` for bold, green, yellow text
         b. Print header: bold "ARS Scan: {rootDir}"
         c. Print separator line
         d. Print "Go files discovered: {total}"
         e. Green "  Source files:      {count}"
         f. Yellow "  Test files:        {count}"
         g. If generated > 0: "  Generated (excluded): {count}"
         h. If vendor > 0: "  Vendor (excluded):    {count}"
         i. If gitignore > 0: "  Gitignored (excluded): {count}"
         j. If verbose: print blank line, then "Discovered files:" header, then for each file: "  [{class}] {relPath}" -- if excluded, append " ({reason})"
       - Color auto-disables when output is not a TTY (fatih/color handles this)
       - Align numbers using fmt.Fprintf width specifiers for clean columns

    6. Create `internal/output/terminal_test.go`:
       - `TestRenderSummary`: Create a ScanResult with known counts, render to bytes.Buffer, assert output contains expected strings (file counts, labels)
       - `TestRenderSummaryVerbose`: Same but verbose=true, assert individual files appear in output

    Note: Tests write to bytes.Buffer which is not a TTY, so color will be auto-disabled. This is correct behavior -- test the content, not the ANSI codes.
  </action>
  <verify>
    `go test ./internal/pipeline/ -v` -- pipeline tests pass.
    `go test ./internal/output/ -v` -- output tests pass.
    `go test ./... -v` -- all project tests pass.
    `go vet ./...` -- no issues.
  </verify>
  <done>
    Pipeline orchestrates discover -> stub parse -> stub analyze -> render. Terminal output shows colored summary with file counts. Verbose mode lists individual files. All tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire pipeline into scan command</name>
  <files>
    cmd/scan.go
  </files>
  <action>
    Update `cmd/scan.go` to replace the placeholder "Scanning: <dir>" with actual pipeline execution:

    1. In the RunE function, after validateGoProject succeeds:
       - Get verbose flag: `verbose, _ := cmd.Flags().GetBool("verbose")` (or use the package-level var from root.go)
       - Create pipeline: `p := pipeline.New(cmd.OutOrStdout(), verbose)`
       - Run pipeline: `err := p.Run(dir)`
       - Return err (cobra handles printing it)

    2. Add imports for the internal/pipeline package.

    3. Ensure the verbose flag from root.go is accessible in scan.go. If verbose is a package-level var in cmd package, it's already accessible. If using persistent flag lookup, use `cmd.Root().PersistentFlags().GetBool("verbose")`.

    Do NOT change validateGoProject or any other existing code. Only replace the placeholder output with the pipeline call.
  </action>
  <verify>
    `go build -o ars . && ./ars scan .` -- prints colored summary of this repository's Go files.
    `./ars scan . --verbose` -- lists individual files with classifications.
    `./ars scan . | cat` -- output has no ANSI color codes (piped, not TTY).
    `./ars scan /tmp 2>&1; echo "exit: $?"` -- prints error, exit code 1.
    `./ars --help` -- still works.
    `./ars --version` -- still works.
  </verify>
  <done>
    `ars scan <dir>` runs the full pipeline and prints a colored file discovery report. Verbose mode shows individual files. Error handling preserved. All previous functionality intact.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete Phase 1 CLI: `ars scan` discovers Go files, classifies them, and prints a colored summary report. The pipeline architecture is in place with stub parse/analyze stages ready for Phase 2.</what-built>
  <how-to-verify>
    1. Run `go build -o ars . && ./ars --help` -- should show help with scan subcommand
    2. Run `./ars --version` -- should print version
    3. Run `./ars scan .` -- should show colored summary with Source/Test file counts for this repo
    4. Run `./ars scan . --verbose` -- should list each discovered file with [source]/[test]/[excluded] tags
    5. Run `./ars scan /tmp` -- should show "not a Go project" error
    6. Run `./ars scan . | cat` -- should show same info but without colors (plain text)
    7. Verify vendor dirs and generated files would be excluded (check verbose output)
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
1. `go test ./... -v` -- all tests across all packages pass
2. `go vet ./...` -- no issues
3. `go build -o ars .` -- binary compiles
4. `./ars scan .` -- produces file discovery report
5. `./ars scan . --verbose` -- shows individual files
6. `./ars scan /nonexistent` -- error with exit 1
7. Phase 1 success criteria from roadmap:
   - "Running `ars scan <directory>` discovers all .go files and reports file counts" -- VERIFIED
   - "Running `ars scan` on non-Go directory produces clear error" -- VERIFIED
   - "Vendor and generated code excluded" -- VERIFIED
   - "`ars --help` and `ars --version` work" -- VERIFIED
   - "Pipeline processes through discovery, parsing stub, analyzer stub, output" -- VERIFIED
</verification>

<success_criteria>
- `ars scan <dir>` produces a complete file discovery report with colored output
- Pipeline architecture established with interfaces for Phase 2 extension
- All Phase 1 roadmap success criteria are met
- All tests pass, code vets clean
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-03-SUMMARY.md`
</output>
