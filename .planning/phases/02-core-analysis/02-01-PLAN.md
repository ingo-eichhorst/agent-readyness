---
phase: 02-core-analysis
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - pkg/types/types.go
  - internal/parser/parser.go
  - internal/parser/parser_test.go
  - internal/pipeline/interfaces.go
  - go.mod
  - go.sum
autonomous: true

must_haves:
  truths:
    - "go/packages.Load successfully parses all packages in a Go module directory"
    - "ParsedPackage carries AST, type info, FileSet, and import map for each package"
    - "Parser and Analyzer interfaces accept the new ParsedPackage type"
    - "Test packages are loaded separately from source packages when Tests=true"
  artifacts:
    - path: "internal/parser/parser.go"
      provides: "GoPackagesParser replacing StubParser"
      exports: ["GoPackagesParser", "ParsedPackage"]
    - path: "pkg/types/types.go"
      provides: "Metric result types (C1Metrics, C3Metrics, C6Metrics, MetricSummary, FunctionMetric)"
      contains: "C1Metrics"
    - path: "internal/pipeline/interfaces.go"
      provides: "Updated Parser and Analyzer interfaces using ParsedPackage"
      contains: "ParsedPackage"
  key_links:
    - from: "internal/parser/parser.go"
      to: "golang.org/x/tools/go/packages"
      via: "packages.Load with NeedSyntax|NeedTypes|NeedTypesInfo"
      pattern: "packages\\.Load"
    - from: "internal/pipeline/interfaces.go"
      to: "internal/parser/parser.go"
      via: "Parser interface returns []*parser.ParsedPackage"
      pattern: "ParsedPackage"
---

<objective>
Replace StubParser with a real go/packages-backed parser and evolve shared types to carry AST data and typed metric results through the pipeline.

Purpose: Every Phase 2 analyzer depends on parsed AST, type info, and import graphs. This plan creates the foundation all three category analyzers (C1, C3, C6) consume.
Output: Working GoPackagesParser, ParsedPackage type, typed metric structs, updated pipeline interfaces.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-core-analysis/02-RESEARCH.md
@pkg/types/types.go
@internal/pipeline/interfaces.go
@internal/pipeline/pipeline.go
@go.mod
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create GoPackagesParser and ParsedPackage type</name>
  <files>
    internal/parser/parser.go
    internal/parser/parser_test.go
    go.mod
    go.sum
  </files>
  <action>
    Create `internal/parser/parser.go` with:

    1. `ParsedPackage` struct containing: ID string, Name string, PkgPath string, GoFiles []string, Syntax []*ast.File, Fset *token.FileSet, Types *types.Package, TypesInfo *types.Info, Imports map[string]*packages.Package, ForTest string (to identify test packages).

    2. `GoPackagesParser` struct with a `Parse(rootDir string) ([]*ParsedPackage, error)` method that:
       - Configures `packages.Config` with Mode: NeedName|NeedFiles|NeedImports|NeedDeps|NeedTypes|NeedSyntax|NeedTypesInfo, Dir: rootDir, Tests: true.
       - Calls `packages.Load(cfg, "./...")`.
       - Iterates results, skipping packages with errors (log warning but continue -- partial results are better than none).
       - Deduplicates packages by PkgPath to avoid test package duplication (see research pitfall #2). For each PkgPath, keep the non-test variant for source analysis. Store test variants separately by checking `pkg.ForTest != ""`.
       - Returns []*ParsedPackage.

    IMPORTANT: Always request NeedSyntax AND NeedTypes AND NeedTypesInfo together (Go issue #69931 -- TypesInfo is nil without all three).

    Install dependencies:
    ```
    go get golang.org/x/tools@latest
    go get github.com/fzipp/gocyclo@latest
    ```

    Create `internal/parser/parser_test.go` with:
    - Test that Parse() on this repository (`.` or `../..` relative to test) returns non-empty packages with ASTs.
    - Test that ParsedPackage.Syntax is non-nil for at least one package.
    - Test that ParsedPackage.Fset is non-nil.
    - Test that test packages are identified (ForTest field set).
  </action>
  <verify>
    `cd /Users/ingo/agent-readyness && go test ./internal/parser/... -v` passes.
    `cd /Users/ingo/agent-readyness && go vet ./internal/parser/...` passes.
  </verify>
  <done>GoPackagesParser.Parse() loads this repository's packages with ASTs, type info, and import maps. Test packages are identified separately.</done>
</task>

<task type="auto">
  <name>Task 2: Evolve shared types and update pipeline interfaces</name>
  <files>
    pkg/types/types.go
    internal/pipeline/interfaces.go
  </files>
  <action>
    Update `pkg/types/types.go` to add typed metric result structs:

    ```go
    // MetricSummary holds avg/max for a numeric metric.
    type MetricSummary struct {
        Avg       float64
        Max       int
        MaxEntity string // which function/file has the max
    }

    // FunctionMetric holds per-function analysis data.
    type FunctionMetric struct {
        Package    string
        Name       string
        File       string
        Line       int
        Complexity int
        LineCount  int
    }

    // DuplicateBlock represents a detected code clone.
    type DuplicateBlock struct {
        FileA     string
        StartA    int
        EndA      int
        FileB     string
        StartB    int
        EndB      int
        LineCount int
    }

    // C1Metrics holds Code Health metric results.
    type C1Metrics struct {
        CyclomaticComplexity MetricSummary
        FunctionLength       MetricSummary
        FileSize             MetricSummary
        AfferentCoupling     map[string]int    // pkg path -> incoming dep count
        EfferentCoupling     map[string]int    // pkg path -> outgoing dep count
        DuplicationRate      float64           // percentage 0-100
        DuplicatedBlocks     []DuplicateBlock
        Functions            []FunctionMetric  // per-function detail
    }

    // C3Metrics holds Architectural Navigability metric results.
    type C3Metrics struct {
        MaxDirectoryDepth   int
        AvgDirectoryDepth   float64
        ModuleFanout        MetricSummary     // avg refs per module
        CircularDeps        [][]string        // each cycle as list of package paths
        ImportComplexity    MetricSummary     // avg relative path segments
        DeadExports         []DeadExport      // unreferenced exported symbols
    }

    // DeadExport represents an exported symbol not referenced within the module.
    type DeadExport struct {
        Package  string
        Name     string
        File     string
        Line     int
        Kind     string // "func", "type", "var", "const"
    }

    // C6Metrics holds Testing Infrastructure metric results.
    type C6Metrics struct {
        TestFileCount    int
        SourceFileCount  int
        TestToCodeRatio  float64           // test LOC / source LOC
        CoveragePercent  float64           // -1 if not available
        CoverageSource   string            // "go-cover", "lcov", "cobertura", "none"
        TestIsolation    float64           // percentage of tests without external deps
        AssertionDensity MetricSummary     // assertions per test function
        TestFunctions    []TestFunctionMetric
    }

    // TestFunctionMetric holds per-test-function data.
    type TestFunctionMetric struct {
        Package        string
        Name           string
        File           string
        Line           int
        AssertionCount int
        HasExternalDep bool
    }
    ```

    Keep ALL existing types (DiscoveredFile, ScanResult, etc.) -- they are still used by discovery.

    Update `internal/pipeline/interfaces.go`:
    - Import the parser package.
    - Change `Parser` interface: `Parse(rootDir string) ([]*parser.ParsedPackage, error)` (takes root dir string, not []DiscoveredFile).
    - Change `Analyzer` interface: `Analyze(pkgs []*parser.ParsedPackage) (*types.AnalysisResult, error)` (takes ParsedPackage slice, not ParsedFile slice).
    - Keep StubParser and StubAnalyzer but update their signatures to match. StubParser returns empty slice. StubAnalyzer ignores input and returns empty result.
    - Update `AnalysisResult` to add a `Category string` field (e.g., "C1", "C3", "C6") alongside Name.

    IMPORTANT: Do NOT remove ParsedFile type from types.go -- it may still be referenced. Just add new types alongside.
  </action>
  <verify>
    `cd /Users/ingo/agent-readyness && go build ./...` compiles without errors.
    `cd /Users/ingo/agent-readyness && go test ./... -count=1` all tests pass (existing + new).
    `cd /Users/ingo/agent-readyness && go vet ./...` passes.
  </verify>
  <done>Pipeline interfaces updated for ParsedPackage. Typed metric structs (C1Metrics, C3Metrics, C6Metrics) available in pkg/types. All existing tests still pass. pipeline.go updated to use new Parser signature (parse takes rootDir, not files).</done>
</task>

</tasks>

<verification>
1. `go build ./...` -- entire project compiles
2. `go test ./... -count=1` -- all tests pass (existing Phase 1 tests + new parser tests)
3. `go vet ./...` -- no issues
4. Parser test proves go/packages loads real ASTs from this repository
</verification>

<success_criteria>
- GoPackagesParser.Parse() returns ParsedPackage slices with non-nil ASTs and type info
- All typed metric structs (C1Metrics, C3Metrics, C6Metrics) defined in pkg/types
- Pipeline interfaces use ParsedPackage (not ParsedFile) for parser and analyzer
- All existing Phase 1 tests continue to pass
- go.mod includes golang.org/x/tools and fzipp/gocyclo
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-analysis/02-01-SUMMARY.md`
</output>
