---
phase: 02-core-analysis
plan: 02
type: tdd
wave: 2
depends_on: ["02-01"]
files_modified:
  - internal/analyzer/c1_codehealth.go
  - internal/analyzer/c1_codehealth_test.go
  - internal/analyzer/helpers.go
  - testdata/complexity/main.go
  - testdata/duplication/dup.go
  - testdata/coupling/pkga/a.go
  - testdata/coupling/pkgb/b.go
  - testdata/coupling/go.mod
autonomous: true

must_haves:
  truths:
    - "Cyclomatic complexity is calculated per function with correct avg and max"
    - "Function length in lines is measured per function with avg and max"
    - "File size in lines is measured per file with avg and max"
    - "Afferent coupling counts incoming dependencies per package"
    - "Efferent coupling counts outgoing dependencies per package"
    - "Duplicated code blocks are detected and duplication rate is calculated"
  artifacts:
    - path: "internal/analyzer/c1_codehealth.go"
      provides: "C1 analyzer implementing Analyzer interface"
      exports: ["C1Analyzer"]
      contains: "func.*Analyze"
    - path: "internal/analyzer/c1_codehealth_test.go"
      provides: "Tests for all 6 C1 metrics"
      contains: "TestC1"
    - path: "internal/analyzer/helpers.go"
      provides: "Shared analysis utilities (import graph builder, line counting)"
      exports: ["ImportGraph", "BuildImportGraph"]
  key_links:
    - from: "internal/analyzer/c1_codehealth.go"
      to: "github.com/fzipp/gocyclo"
      via: "gocyclo.AnalyzeASTFile for complexity"
      pattern: "gocyclo\\.AnalyzeASTFile"
    - from: "internal/analyzer/c1_codehealth.go"
      to: "internal/analyzer/helpers.go"
      via: "BuildImportGraph for coupling metrics"
      pattern: "BuildImportGraph"
    - from: "internal/analyzer/c1_codehealth.go"
      to: "pkg/types/types.go"
      via: "Returns AnalysisResult with C1Metrics"
      pattern: "C1Metrics"
---

<objective>
Implement the C1 Code Health analyzer with all 6 metrics: cyclomatic complexity (C1-01), function length (C1-02), file size (C1-03), afferent coupling (C1-04), efferent coupling (C1-05), and duplication detection (C1-06).

Purpose: C1 is the largest metric category (25% of composite score) and provides the most actionable code-level insights. Per-function metrics help identify specific functions that need improvement.
Output: Working, tested C1Analyzer with all 6 metrics producing typed C1Metrics results.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-core-analysis/02-RESEARCH.md
@.planning/phases/02-core-analysis/02-01-SUMMARY.md
@pkg/types/types.go
@internal/parser/parser.go
@internal/pipeline/interfaces.go
</context>

<feature>
  <name>C1 Code Health Analyzer</name>
  <files>
    internal/analyzer/c1_codehealth.go
    internal/analyzer/c1_codehealth_test.go
    internal/analyzer/helpers.go
    testdata/complexity/main.go
    testdata/duplication/dup.go
    testdata/coupling/pkga/a.go
    testdata/coupling/pkgb/b.go
    testdata/coupling/go.mod
  </files>
  <behavior>
    C1Analyzer implements the Analyzer interface and returns AnalysisResult with C1Metrics.

    Test cases:

    **Cyclomatic complexity (C1-01):**
    - A function with no branches -> complexity 1
    - A function with 1 if statement -> complexity 2
    - A function with if + for + switch(3 cases) -> complexity 6
    - Use gocyclo.AnalyzeASTFile (do NOT hand-roll)

    **Function length (C1-02):**
    - A 5-line function -> LineCount 5
    - A 50-line function -> LineCount 50
    - Measured via fset.Position(fn.End()).Line - fset.Position(fn.Pos()).Line + 1

    **File size (C1-03):**
    - Measured via fset.Position(f.End()).Line
    - Avg and max across all source files (excluding test files)

    **Afferent coupling (C1-04):**
    - Package A imported by B and C -> afferent = 2
    - Only count intra-module imports (filter by module path from go.mod)

    **Efferent coupling (C1-05):**
    - Package A imports B and C -> efferent = 2
    - Only count intra-module imports

    **Duplication (C1-06):**
    - Two identical 6+ line blocks -> detected as duplicate
    - Duplication rate = duplicated lines / total lines * 100
    - Use AST statement-sequence hashing with FNV hash
    - Minimum threshold: 3 consecutive statements or 6 lines
    - Skip test files for duplication analysis

    Shared helpers (helpers.go):
    - ImportGraph struct with Forward/Reverse adjacency lists
    - BuildImportGraph(pkgs, modulePath) -> *ImportGraph
    - modulePath extracted from go.mod or first package prefix
  </behavior>
  <implementation>
    1. Create testdata fixtures:
       - `testdata/complexity/main.go`: Functions with known complexity (1, 3, 6+)
       - `testdata/duplication/dup.go`: Two identical 8-line blocks
       - `testdata/coupling/`: Two packages that import each other's types

    2. Create `internal/analyzer/helpers.go`:
       - ImportGraph struct and BuildImportGraph function
       - Line counting helpers

    3. Create `internal/analyzer/c1_codehealth.go`:
       - C1Analyzer struct implementing Analyzer interface
       - Name() returns "C1: Code Health"
       - Analyze() orchestrates all 6 sub-analyzers
       - analyzeComplexity() uses gocyclo.AnalyzeASTFile
       - analyzeFunctionLengths() uses fset position arithmetic
       - analyzeFileSizes() uses fset position arithmetic
       - analyzeCoupling() uses ImportGraph
       - analyzeDuplication() uses AST statement hashing

    4. Filter: Skip test packages (ForTest != "") for all C1 metrics.
       Test packages should only be analyzed by C6.
  </implementation>
</feature>

<verification>
1. `cd /Users/ingo/agent-readyness && go test ./internal/analyzer/... -v -run TestC1` -- all C1 tests pass
2. `go vet ./internal/analyzer/...` -- no issues
3. Tests verify specific numeric outputs for known testdata inputs
</verification>

<success_criteria>
- C1Analyzer.Analyze() returns C1Metrics with all 6 metric fields populated
- Cyclomatic complexity uses gocyclo (not hand-rolled)
- Coupling metrics only count intra-module imports
- Duplication detection uses AST hashing with minimum 6-line threshold
- All tests pass with correct expected values for testdata fixtures
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-analysis/02-02-SUMMARY.md`
</output>
