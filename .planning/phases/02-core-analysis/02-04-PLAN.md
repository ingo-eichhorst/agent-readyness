---
phase: 02-core-analysis
plan: 04
type: tdd
wave: 2
depends_on: ["02-01"]
files_modified:
  - internal/analyzer/c6_testing.go
  - internal/analyzer/c6_testing_test.go
  - testdata/coverage/cover.out
  - testdata/coverage/lcov.info
  - testdata/coverage/cobertura.xml
autonomous: true

must_haves:
  truths:
    - "Test files are detected by _test.go suffix and test package membership"
    - "Test-to-code ratio is calculated as test LOC divided by source LOC"
    - "Coverage reports are parsed from Go cover profiles, LCOV, and Cobertura formats"
    - "Test isolation identifies tests with external dependencies (net/http, database/sql, os/exec)"
    - "Assertion density counts assertions per test function including testify methods"
  artifacts:
    - path: "internal/analyzer/c6_testing.go"
      provides: "C6 analyzer implementing Analyzer interface"
      exports: ["C6Analyzer"]
      contains: "func.*Analyze"
    - path: "internal/analyzer/c6_testing_test.go"
      provides: "Tests for all 5 C6 metrics"
      contains: "TestC6"
    - path: "testdata/coverage/cover.out"
      provides: "Sample Go coverage profile for parsing tests"
  key_links:
    - from: "internal/analyzer/c6_testing.go"
      to: "golang.org/x/tools/cover"
      via: "cover.ParseProfiles for Go coverage files"
      pattern: "cover\\.ParseProfiles"
    - from: "internal/analyzer/c6_testing.go"
      to: "pkg/types/types.go"
      via: "Returns AnalysisResult with C6Metrics"
      pattern: "C6Metrics"
---

<objective>
Implement the C6 Testing Infrastructure analyzer with all 5 metrics: test detection (C6-01), test-to-code ratio (C6-02), coverage parsing (C6-03), test isolation (C6-04), and assertion density (C6-05).

Purpose: C6 measures how well the test suite supports agent workflows. Agents rely on tests to verify their changes -- low coverage, poor isolation, and sparse assertions mean agents can't validate their work. This category is 15% of the composite score.
Output: Working, tested C6Analyzer with all 5 metrics producing typed C6Metrics results.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-core-analysis/02-RESEARCH.md
@.planning/phases/02-core-analysis/02-01-SUMMARY.md
@pkg/types/types.go
@internal/parser/parser.go
</context>

<feature>
  <name>C6 Testing Infrastructure Analyzer</name>
  <files>
    internal/analyzer/c6_testing.go
    internal/analyzer/c6_testing_test.go
    testdata/coverage/cover.out
    testdata/coverage/lcov.info
    testdata/coverage/cobertura.xml
  </files>
  <behavior>
    C6Analyzer implements the Analyzer interface and returns AnalysisResult with C6Metrics.

    Test cases:

    **Test detection (C6-01):**
    - Files ending in _test.go are test files
    - Packages with ForTest != "" are test packages
    - Count test files and source files separately

    **Test-to-code ratio (C6-02):**
    - 100 lines test code, 400 lines source -> ratio 0.25
    - Count LOC using fset.Position(f.End()).Line for each file in test vs source packages
    - Only count .go files (not go.mod, etc.)

    **Coverage parsing (C6-03):**
    - Go native: parse cover.out using cover.ParseProfiles. Calculate covered/total statements.
    - LCOV: parse lcov.info line-by-line. SF: starts file, DA:line,count for each line, end_of_record ends file.
    - Cobertura: parse cobertura.xml using encoding/xml. Extract line-rate attribute from coverage element.
    - Search order: look for cover.out, then coverage.lcov/lcov.info, then coverage.xml/cobertura.xml in project root.
    - If no coverage file found, set CoveragePercent = -1 and CoverageSource = "none".

    **Test isolation (C6-04):**
    - Test file importing "net/http" -> not isolated
    - Test file importing only "testing" and project packages -> isolated
    - External dependency packages: net/http, net, database/sql, os/exec, net/rpc, net/smtp
    - Also flag: imports of third-party HTTP clients, database drivers
    - Report as percentage: isolated tests / total tests * 100

    **Assertion density (C6-05):**
    - Test function with 3 t.Error/t.Fatal calls -> density 3
    - Test function using testify assert.Equal, require.NoError -> count those too
    - Standard testing methods: Error, Errorf, Fatal, Fatalf, Fail, FailNow
    - Testify methods: Equal, NotEqual, True, False, Nil, NotNil, Contains, NoError, Len, Empty, Greater, Less, ErrorIs, ErrorAs
    - Report avg and max assertions per test function

    Coverage testdata:
    - cover.out: Valid Go coverage profile with mode: set, a few file entries
    - lcov.info: Valid LCOV file with SF/DA/LF/LH/end_of_record
    - cobertura.xml: Valid Cobertura XML with coverage line-rate attribute
  </behavior>
  <implementation>
    1. Create testdata coverage fixtures:
       - `testdata/coverage/cover.out`: Go coverage profile (mode: set, 2-3 files, known covered/uncovered statements)
       - `testdata/coverage/lcov.info`: LCOV format with known line counts
       - `testdata/coverage/cobertura.xml`: Cobertura XML with line-rate="0.75"

    2. Create `internal/analyzer/c6_testing.go`:
       - C6Analyzer struct implementing Analyzer interface
       - Name() returns "C6: Testing"
       - Analyze(pkgs) orchestrates all 5 sub-analyzers
       - Separate test packages (ForTest != "") from source packages
       - countTestFiles() counts files in test packages
       - calculateTestRatio() sums LOC in test vs source files
       - parseCoverage(rootDir) tries Go cover, LCOV, Cobertura in order
       - parseGoCoverage(path) uses cover.ParseProfiles
       - parseLCOV(path) custom line-based parser
       - parseCobertura(path) uses encoding/xml
       - analyzeIsolation(testPkgs) checks imports of test packages
       - analyzeAssertions(testPkgs) counts assertion calls per test function

    3. For assertion counting, inspect test functions (name starts with "Test" and has *testing.T parameter):
       - Walk function body AST
       - Count method calls matching assertion patterns on selector expressions
       - Handle both `t.Error()` style and `assert.Equal()` style

    4. The rootDir for coverage file search should be passed via the ParsedPackage data or derived from the first package's directory.
  </implementation>
</feature>

<verification>
1. `cd /Users/ingo/agent-readyness && go test ./internal/analyzer/... -v -run TestC6` -- all C6 tests pass
2. `go vet ./internal/analyzer/...` -- no issues
3. Coverage parsing tests verify correct percentages from known fixture files
4. Assertion density test verifies correct count for known test functions
</verification>

<success_criteria>
- C6Analyzer.Analyze() returns C6Metrics with all 5 metric fields populated
- Go coverage profile parsing uses x/tools/cover.ParseProfiles (not hand-rolled)
- LCOV and Cobertura parsing handles missing/empty files gracefully
- Test isolation correctly identifies external dependency imports
- Assertion density counts both standard testing and testify assertion methods
- All tests pass with correct expected values
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-analysis/02-04-SUMMARY.md`
</output>
