---
phase: 02-core-analysis
plan: 05
type: execute
wave: 3
depends_on: ["02-02", "02-03", "02-04"]
files_modified:
  - internal/pipeline/pipeline.go
  - internal/pipeline/pipeline_test.go
  - internal/output/terminal.go
  - internal/output/terminal_test.go
  - cmd/scan.go
autonomous: false

must_haves:
  truths:
    - "Running ars scan on a Go project reports C1, C3, and C6 metric summaries"
    - "Pipeline runs parser then all three analyzers in sequence"
    - "Output displays per-category metric highlights (complexity avg/max, test ratio, coverage)"
    - "Verbose mode shows per-function and per-package metric details"
    - "Errors in individual analyzers are logged but do not abort the scan"
  artifacts:
    - path: "internal/pipeline/pipeline.go"
      provides: "Pipeline wired with GoPackagesParser and all 3 analyzers"
      contains: "C1Analyzer"
    - path: "internal/output/terminal.go"
      provides: "Metric summary rendering for C1, C3, C6 categories"
      contains: "C1Metrics"
  key_links:
    - from: "internal/pipeline/pipeline.go"
      to: "internal/parser/parser.go"
      via: "Pipeline creates GoPackagesParser"
      pattern: "parser\\.GoPackagesParser"
    - from: "internal/pipeline/pipeline.go"
      to: "internal/analyzer/c1_codehealth.go"
      via: "Pipeline registers C1Analyzer"
      pattern: "C1Analyzer"
    - from: "internal/pipeline/pipeline.go"
      to: "internal/analyzer/c3_architecture.go"
      via: "Pipeline registers C3Analyzer"
      pattern: "C3Analyzer"
    - from: "internal/pipeline/pipeline.go"
      to: "internal/analyzer/c6_testing.go"
      via: "Pipeline registers C6Analyzer"
      pattern: "C6Analyzer"
    - from: "internal/output/terminal.go"
      to: "pkg/types/types.go"
      via: "Renders C1Metrics, C3Metrics, C6Metrics"
      pattern: "C1Metrics|C3Metrics|C6Metrics"
---

<objective>
Wire all three analyzers (C1, C3, C6) into the pipeline, update terminal output to display metric results, and verify end-to-end with a real scan.

Purpose: This plan connects all the pieces built in plans 02-04. Without wiring, the analyzers exist but are never called. The output update makes metrics visible to the user.
Output: Fully functional `ars scan` command that discovers files, parses packages, runs all analyzers, and displays metric results.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-core-analysis/02-RESEARCH.md
@.planning/phases/02-core-analysis/02-01-SUMMARY.md
@.planning/phases/02-core-analysis/02-02-SUMMARY.md
@.planning/phases/02-core-analysis/02-03-SUMMARY.md
@.planning/phases/02-core-analysis/02-04-SUMMARY.md
@internal/pipeline/pipeline.go
@internal/output/terminal.go
@cmd/scan.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire analyzers into pipeline and update output rendering</name>
  <files>
    internal/pipeline/pipeline.go
    internal/pipeline/pipeline_test.go
    internal/output/terminal.go
    internal/output/terminal_test.go
    cmd/scan.go
  </files>
  <action>
    Update `internal/pipeline/pipeline.go`:
    1. Change `New()` to create `GoPackagesParser` instead of `StubParser`.
    2. Change `New()` to register `C1Analyzer{}`, `C3Analyzer{}`, `C6Analyzer{}` instead of `StubAnalyzer`.
    3. Update `Run()` flow:
       - Stage 1: Discover files (unchanged)
       - Stage 2: Parse packages using `p.parser.Parse(dir)` -- now returns []*ParsedPackage
       - Stage 3: Run each analyzer with the parsed packages. Collect results. If an analyzer returns error, log warning and continue (don't abort).
       - Stage 4: Render output with scan result AND analysis results.
    4. Update Pipeline struct to store analysis results: `results []*types.AnalysisResult`.
    5. Pass analysis results to output renderer.

    Update `internal/output/terminal.go`:
    1. Update `RenderSummary` signature to accept analysis results: `RenderSummary(w io.Writer, scanResult *types.ScanResult, analysisResults []*types.AnalysisResult, verbose bool)`.
    2. After file discovery summary, add a "Metrics" section:
       - For C1: Show complexity avg/max, function length avg/max, file size avg/max, duplication rate
       - For C3: Show max directory depth, avg fanout, circular dep count, dead export count
       - For C6: Show test-to-code ratio, coverage %, test isolation %, assertion density avg
    3. Use color: green for good values, yellow for moderate, red for concerning (define simple thresholds: complexity avg > 10 is yellow, > 20 is red, etc.).
    4. In verbose mode, additionally show:
       - Top 5 most complex functions (name, file, complexity)
       - Top 5 longest functions (name, file, lines)
       - Packages with highest coupling
       - Dead exports list
       - Per-test function assertion counts

    Update `cmd/scan.go` if needed to pass any new options.

    Update pipeline tests to verify the new flow compiles and runs.
  </action>
  <verify>
    `cd /Users/ingo/agent-readyness && go build ./...` compiles.
    `cd /Users/ingo/agent-readyness && go test ./... -count=1` all tests pass.
    `cd /Users/ingo/agent-readyness && go vet ./...` passes.
  </verify>
  <done>Pipeline runs GoPackagesParser and all three analyzers. Output displays metric summaries for C1, C3, C6. Verbose mode shows detailed per-function/per-package metrics.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete Phase 2 analysis pipeline: ars scan now parses Go packages, computes all 16 metrics across C1/C3/C6, and displays results in terminal output.</what-built>
  <how-to-verify>
    1. Run `cd /Users/ingo/agent-readyness && go run . scan .` -- should show file discovery summary plus C1/C3/C6 metric summaries
    2. Run `cd /Users/ingo/agent-readyness && go run . scan . --verbose` -- should additionally show top complex functions, longest functions, dead exports, etc.
    3. Verify metrics look reasonable for this repository (small project, low complexity expected)
    4. Run `cd /Users/ingo/agent-readyness && go test ./... -count=1` -- all tests pass
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
1. `go build ./...` compiles
2. `go test ./... -count=1` all tests pass
3. `go run . scan .` produces metric output (not just file counts)
4. `go run . scan . --verbose` shows detailed metrics
5. No panics or crashes on this repository
</verification>

<success_criteria>
- `ars scan <dir>` shows C1, C3, C6 metric summaries in terminal output
- Verbose mode shows top functions by complexity, top functions by length, coupling details, dead exports, test details
- Pipeline gracefully handles analyzer errors (logs warning, continues)
- All existing and new tests pass
- User confirms output looks correct for this repository
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-analysis/02-05-SUMMARY.md`
</output>
