---
phase: 05-hardening
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - internal/discovery/walker.go
  - internal/discovery/walker_test.go
  - pkg/types/types.go
autonomous: true

must_haves:
  truths:
    - "Symlinks in the scanned directory are detected, logged as warnings, and skipped without aborting the scan"
    - "Permission-denied errors on individual files or directories do not abort the scan"
    - "Files with Go syntax errors do not crash the scanner (parser already handles this -- verify with test)"
    - "Unicode-named Go files and directories are discovered and classified correctly"
    - "The scan result reports how many files were skipped and why"
  artifacts:
    - path: "internal/discovery/walker.go"
      provides: "Resilient WalkDir callback with symlink detection, error recovery"
      contains: "ModeSymlink"
    - path: "internal/discovery/walker_test.go"
      provides: "Tests for symlink, permission error, and Unicode path handling"
      contains: "TestWalkerSymlink"
    - path: "pkg/types/types.go"
      provides: "SkippedCount and SymlinkCount fields on ScanResult"
      contains: "SkippedCount"
  key_links:
    - from: "internal/discovery/walker.go"
      to: "pkg/types/types.go"
      via: "ScanResult.SkippedCount and ScanResult.SymlinkCount fields"
      pattern: "result\\.SkippedCount|result\\.SymlinkCount"
---

<objective>
Make the file discovery walker resilient to real-world edge cases: symlinks, permission errors, and Unicode paths.

Purpose: Currently the walker aborts the entire scan on any WalkDir error (line 57-59 returns err directly). In real codebases, symlinks, permission-denied files, and other edge cases are common. The tool must continue scanning and report what it skipped.
Output: A hardened walker that logs warnings and continues, with test coverage for all edge case categories.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-hardening/05-RESEARCH.md
@internal/discovery/walker.go
@internal/discovery/walker_test.go
@pkg/types/types.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add skip tracking fields to ScanResult and harden WalkDir callback</name>
  <files>pkg/types/types.go, internal/discovery/walker.go</files>
  <action>
  1. In `pkg/types/types.go`, add two fields to `ScanResult`:
     - `SkippedCount int` -- files/dirs skipped due to errors (permission denied, broken paths, etc.)
     - `SymlinkCount int` -- symlinks detected and skipped

  2. In `internal/discovery/walker.go`, modify the `filepath.WalkDir` callback:

     a. **Error recovery (line 57-59):** Instead of `return err`, log a warning to stderr and continue:
        - If `d != nil && d.IsDir()`: increment `result.SkippedCount`, return `fs.SkipDir`
        - Otherwise: increment `result.SkippedCount`, return `nil`
        - Use `fmt.Fprintf(os.Stderr, "warning: skipping %s: %v\n", path, err)` for the warning

     b. **Symlink detection:** BEFORE the `d.IsDir()` check (line 64), add symlink detection:
        - Check `d.Type()&fs.ModeSymlink != 0`
        - If symlink: increment `result.SymlinkCount`, print warning to stderr, return `nil`
        - This catches both file and directory symlinks (WalkDir visits directory symlink entries but does not recurse into them)

     c. **Generated file error recovery (line 113-116):** Instead of returning the error from `IsGeneratedFile`, log warning to stderr, increment `result.SkippedCount`, and continue (return nil). A single unreadable file should not abort the scan.

     d. **Relative path error recovery (line 82-85):** Instead of returning the error from `filepath.Rel`, log warning, increment `result.SkippedCount`, return nil.

     e. **Walk error at the end (line 140-142):** This should now be unreachable since we never return errors from the callback. Keep it as a safety net but the walker should never abort now.

  Important: Warnings go to `os.Stderr`, NOT to the writer/stdout. This prevents corruption of `--json` output.
  </action>
  <verify>
  Run `go build ./...` to confirm compilation.
  Run existing tests: `go test ./internal/discovery/ -v` -- all existing tests must still pass.
  </verify>
  <done>ScanResult has SkippedCount and SymlinkCount fields. Walker callback never returns errors for individual file/directory issues -- it logs to stderr and continues.</done>
</task>

<task type="auto">
  <name>Task 2: Add edge case tests for symlinks, permissions, and Unicode paths</name>
  <files>internal/discovery/walker_test.go</files>
  <action>
  Add test cases in `internal/discovery/walker_test.go`:

  1. **TestWalkerSymlink:** Create a temp directory with:
     - A regular .go file
     - A symlink to a .go file (`os.Symlink`)
     - A symlink to a directory
     - Run `Discover()`, assert: the regular file is found, SymlinkCount >= 1 (exact count depends on OS behavior), no error returned

  2. **TestWalkerPermissionDenied:** Create a temp directory with:
     - A regular .go file
     - A subdirectory with `os.Chmod(subdir, 0o000)` (unreadable)
     - Run `Discover()`, assert: the regular file is found, SkippedCount >= 1, no error returned
     - Use `t.Cleanup` to restore permissions before temp dir cleanup
     - Skip on Windows with `if runtime.GOOS == "windows" { t.Skip("permission test not reliable on Windows") }`

  3. **TestWalkerUnicodePaths:** Create a temp directory with a Unicode-named subdirectory (e.g., "pkg_unicod\u00e9") containing a valid .go file (`package main` content). Run `Discover()`, assert: the file is found and classified as ClassSource, no error returned.

  4. **TestWalkerContinuesOnBadGeneratedCheck:** Create a temp directory with a .go file that has mode 0o000 (unreadable -- so IsGeneratedFile will fail). Run `Discover()`, assert: SkippedCount >= 1, no error returned. (Skip on Windows.)

  Use `os.MkdirTemp` for all test fixtures. Write minimal valid .go file content: `package main\n`.
  </action>
  <verify>
  Run `go test ./internal/discovery/ -v -run "TestWalkerSymlink|TestWalkerPermission|TestWalkerUnicode|TestWalkerContinues"` -- all new tests pass.
  Run full test suite: `go test ./...` -- no regressions.
  </verify>
  <done>Four new test cases cover symlinks, permission errors, Unicode paths, and unreadable-file recovery. All pass. Full test suite has no regressions.</done>
</task>

</tasks>

<verification>
1. `go build ./...` succeeds
2. `go test ./internal/discovery/ -v` -- all tests pass including new edge case tests
3. `go test ./...` -- full suite passes, no regressions
4. Manual spot check: `grep "ModeSymlink" internal/discovery/walker.go` confirms symlink detection
5. Manual spot check: `grep "SkippedCount" pkg/types/types.go` confirms new field exists
</verification>

<success_criteria>
- Walker never aborts on symlinks, permission errors, or unreadable files
- ScanResult tracks SkippedCount and SymlinkCount
- Warnings go to stderr (not stdout)
- Four new tests cover the edge cases
- Full test suite passes with no regressions
</success_criteria>

<output>
After completion, create `.planning/phases/05-hardening/05-01-SUMMARY.md`
</output>
