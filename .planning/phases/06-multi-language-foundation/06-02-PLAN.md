---
phase: 06-multi-language-foundation
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - internal/discovery/walker.go
  - internal/discovery/classifier.go
  - internal/discovery/walker_test.go
  - internal/discovery/classifier_test.go
  - internal/parser/treesitter.go
  - internal/parser/treesitter_test.go
  - pkg/types/types.go
  - go.mod
  - go.sum
  - testdata/valid-python-project/app.py
  - testdata/valid-python-project/test_app.py
  - testdata/valid-python-project/pyproject.toml
  - testdata/valid-ts-project/src/index.ts
  - testdata/valid-ts-project/src/index.test.ts
  - testdata/valid-ts-project/tsconfig.json
  - testdata/valid-ts-project/package.json
  - testdata/polyglot-project/main.go
  - testdata/polyglot-project/util.py
  - testdata/polyglot-project/helper.ts
autonomous: true

must_haves:
  truths:
    - "Walker discovers .py files in Python projects and returns them in ScanResult"
    - "Walker discovers .ts/.tsx files in TypeScript projects and returns them in ScanResult"
    - "Walker discovers files from multiple languages in a polyglot repo"
    - "Tree-sitter can parse Python files and produce syntax trees"
    - "Tree-sitter can parse TypeScript files and produce syntax trees"
    - "Tree-sitter parsers are properly closed (no memory leaks)"
  artifacts:
    - path: "internal/discovery/walker.go"
      provides: "Multi-language file discovery"
      contains: ".py"
    - path: "internal/discovery/classifier.go"
      provides: "Per-language file classification"
      contains: "ClassifyPythonFile"
    - path: "internal/parser/treesitter.go"
      provides: "Tree-sitter parser pool for Python and TypeScript"
      contains: "TreeSitterParser"
    - path: "testdata/valid-python-project/app.py"
      provides: "Python test fixture"
    - path: "testdata/valid-ts-project/src/index.ts"
      provides: "TypeScript test fixture"
  key_links:
    - from: "internal/discovery/walker.go"
      to: "internal/discovery/classifier.go"
      via: "ClassifyPythonFile and ClassifyTypeScriptFile calls"
      pattern: "Classify(Python|TypeScript)File"
    - from: "internal/parser/treesitter.go"
      to: "tree-sitter/go-tree-sitter"
      via: "CGO bindings for parsing"
      pattern: "tree_sitter\\.NewParser"
---

<objective>
Add multi-language file discovery (Python + TypeScript) to the walker and integrate Tree-sitter parsing for Python and TypeScript source files.

Purpose: Enables ARS to find and parse non-Go source files, which is required before any Python/TypeScript analysis can run.
Output: Extended walker, language classifier, Tree-sitter parser pool, and test fixtures for Python/TypeScript/polyglot projects.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-multi-language-foundation/06-RESEARCH.md
@.planning/phases/06-multi-language-foundation/06-01-SUMMARY.md

@internal/discovery/walker.go
@internal/discovery/classifier.go
@internal/discovery/walker_test.go
@internal/discovery/classifier_test.go
@internal/parser/parser.go
@pkg/types/types.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend discovery walker and classifier for multi-language</name>
  <files>
    internal/discovery/walker.go
    internal/discovery/classifier.go
    internal/discovery/walker_test.go
    internal/discovery/classifier_test.go
    pkg/types/types.go
    testdata/valid-python-project/app.py
    testdata/valid-python-project/test_app.py
    testdata/valid-python-project/pyproject.toml
    testdata/valid-ts-project/src/index.ts
    testdata/valid-ts-project/src/index.test.ts
    testdata/valid-ts-project/tsconfig.json
    testdata/valid-ts-project/package.json
    testdata/polyglot-project/main.go
    testdata/polyglot-project/util.py
    testdata/polyglot-project/helper.ts
  </files>
  <action>
1. Add a `Language` field to `types.DiscoveredFile` struct. Add `PerLanguage map[types.Language]int` to `types.ScanResult` for per-language source counts.

2. Update `internal/discovery/walker.go`:
   - Change the `.go`-only filter (line 90: `if !strings.HasSuffix(name, ".go")`) to accept `.go`, `.py`, `.ts`, `.tsx` extensions
   - Map file extension to `types.Language`: `.go` -> LangGo, `.py` -> LangPython, `.ts`/`.tsx` -> LangTypeScript
   - Set the Language field on each DiscoveredFile
   - Add `__pycache__`, `dist`, `build`, `.venv`, `venv`, `env` to skipDirs
   - Track per-language counts in ScanResult.PerLanguage
   - Keep existing vendor, gitignore, and generated file logic for .go files
   - For Python: check `IsGeneratedFile` is not called (no generated pattern for Python)
   - For TypeScript: skip files in `node_modules` (already skipped via skipDirs)

3. Update `internal/discovery/classifier.go`:
   - Add `ClassifyPythonFile(name string) types.FileClass` -- test files match `test_*.py` or `*_test.py` patterns
   - Add `ClassifyTypeScriptFile(name string) types.FileClass` -- test files match `*.test.ts`, `*.spec.ts`, `*.test.tsx`, `*.spec.tsx`
   - Keep `ClassifyGoFile` unchanged

4. Add language detection helpers: `DetectProjectLanguages(rootDir string) []types.Language` that checks for:
   - Go: go.mod or .go files present
   - Python: pyproject.toml, setup.py, setup.cfg, requirements.txt, or .py files
   - TypeScript: tsconfig.json, or package.json with "typescript" in dependencies/devDependencies, or .ts files

5. Create test fixtures:
   - `testdata/valid-python-project/`: app.py (simple Flask-like app with type annotations), test_app.py (pytest test), pyproject.toml (minimal)
   - `testdata/valid-ts-project/`: src/index.ts (simple Express-like app with types), src/index.test.ts (jest test), tsconfig.json (strict mode), package.json (with typescript dep)
   - `testdata/polyglot-project/`: main.go (simple Go file), util.py (Python file), helper.ts (TS file)

6. Update tests:
   - Add classifier tests for Python and TypeScript file classification
   - Add walker tests that discover files in valid-python-project and valid-ts-project
   - Add polyglot test that discovers files from all three languages
   - Ensure existing Go walker tests still pass
  </action>
  <verify>
`cd /Users/ingo/agent-readyness && go test ./internal/discovery/... -v` -- all tests pass including new multi-language tests
  </verify>
  <done>Walker discovers .py, .ts, .tsx files. Classifier handles Python/TypeScript test patterns. Language detection works. Test fixtures exist. All existing Go discovery tests still pass.</done>
</task>

<task type="auto">
  <name>Task 2: Integrate Tree-sitter parser for Python and TypeScript</name>
  <files>
    internal/parser/treesitter.go
    internal/parser/treesitter_test.go
    go.mod
    go.sum
  </files>
  <action>
1. Install Tree-sitter dependencies:
   ```
   cd /Users/ingo/agent-readyness
   go get github.com/tree-sitter/go-tree-sitter@latest
   go get github.com/tree-sitter/tree-sitter-python/bindings/go@latest
   go get github.com/tree-sitter/tree-sitter-typescript/bindings/go@latest
   ```

2. Create `internal/parser/treesitter.go`:
   - `TreeSitterParser` struct with pooled parsers: one for Python, one for TypeScript, one for TSX
   - `NewTreeSitterParser() (*TreeSitterParser, error)` creates all three parsers and sets their languages
   - `Close()` method that closes all three parsers
   - `ParseFile(lang types.Language, content []byte) (*tree_sitter.Tree, error)` that selects the right parser based on language. For TypeScript, check file extension passed as additional parameter or use a `ParseFileWithExt` variant that accepts extension to distinguish `.ts` (TypeScript grammar) from `.tsx` (TSX grammar)
   - `ParseTargetFiles(target *types.AnalysisTarget) ([]*ParsedTreeSitterFile, error)` that parses all source files in a target, returning parsed trees. Caller must close trees.
   - `ParsedTreeSitterFile` struct: `{ Path, RelPath string; Tree *tree_sitter.Tree; Content []byte; Language types.Language }`

3. CRITICAL memory management:
   - Every `Parser`, `Tree` must have explicit `Close()` calls
   - `ParseTargetFiles` documents that caller must close returned trees
   - Add a `CloseAll(files []*ParsedTreeSitterFile)` helper that closes all trees in a slice

4. Write tests in `internal/parser/treesitter_test.go`:
   - Test parsing a Python file from testdata/valid-python-project/app.py
   - Test parsing a TypeScript file from testdata/valid-ts-project/src/index.ts
   - Verify root node is not nil and has children
   - Verify Close() does not panic
   - Test that parser reuse works (parse multiple files sequentially)
  </action>
  <verify>
`cd /Users/ingo/agent-readyness && CGO_ENABLED=1 go test ./internal/parser/... -v` -- all tests pass including new Tree-sitter tests. Also: `CGO_ENABLED=1 go build ./...` succeeds.
  </verify>
  <done>TreeSitterParser exists with Python, TypeScript, TSX support. Parsers pool correctly. Memory management via explicit Close(). Tests verify parsing of real Python/TypeScript files.</done>
</task>

</tasks>

<verification>
1. `CGO_ENABLED=1 go build ./...` succeeds
2. `CGO_ENABLED=1 go test ./...` all tests pass
3. `go vet ./...` no issues
4. Walker finds .py, .ts files in test fixtures
5. Tree-sitter parses Python and TypeScript source files
6. Existing Go discovery and parsing tests still pass
</verification>

<success_criteria>
- Multi-language discovery works for Go, Python, TypeScript
- Tree-sitter parses Python and TypeScript files correctly
- Test fixtures exist for Python, TypeScript, and polyglot projects
- Memory management is explicit (Close() on all Tree-sitter objects)
- No regressions in existing Go tests
</success_criteria>

<output>
After completion, create `.planning/phases/06-multi-language-foundation/06-02-SUMMARY.md`
</output>
