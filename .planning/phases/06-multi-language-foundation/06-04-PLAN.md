---
phase: 06-multi-language-foundation
plan: 04
type: execute
wave: 3
depends_on: ["06-02", "06-03"]
files_modified:
  - internal/analyzer/c2_python.go
  - internal/analyzer/c2_python_test.go
  - internal/analyzer/c2_typescript.go
  - internal/analyzer/c2_typescript_test.go
  - internal/analyzer/c2_semantics.go
  - internal/config/config.go
  - internal/config/config_test.go
  - internal/pipeline/pipeline.go
  - internal/output/terminal.go
  - internal/output/json.go
  - cmd/scan.go
autonomous: true

must_haves:
  truths:
    - "User can run ars scan on a Python project and see C2 scores (type annotation coverage, naming consistency, magic numbers)"
    - "User can run ars scan on a TypeScript project and see C2 scores (type coverage, strict mode, null safety)"
    - "User can run ars scan on a mixed-language repo and see per-language C2 analysis"
    - "User can provide a .arsrc.yml config to customize category weights and metric thresholds"
    - "Non-LLM analysis completes in under 30 seconds for a 50k LOC repository"
    - "ars scan auto-detects project languages without user flags"
  artifacts:
    - path: "internal/analyzer/c2_python.go"
      provides: "Python C2 analysis via Tree-sitter"
      contains: "C2PythonAnalyzer"
    - path: "internal/analyzer/c2_typescript.go"
      provides: "TypeScript C2 analysis via Tree-sitter"
      contains: "C2TypeScriptAnalyzer"
    - path: "internal/config/config.go"
      provides: ".arsrc.yml config loading and validation"
      contains: "LoadProjectConfig"
    - path: "cmd/scan.go"
      provides: "CLI with --config flag and multi-language support"
      contains: "config"
  key_links:
    - from: "internal/analyzer/c2_semantics.go"
      to: "internal/analyzer/c2_python.go"
      via: "C2Analyzer dispatches Python targets to C2PythonAnalyzer"
      pattern: "pyAnalyzer\\.Analyze"
    - from: "internal/analyzer/c2_semantics.go"
      to: "internal/analyzer/c2_typescript.go"
      via: "C2Analyzer dispatches TypeScript targets to C2TypeScriptAnalyzer"
      pattern: "tsAnalyzer\\.Analyze"
    - from: "internal/pipeline/pipeline.go"
      to: "internal/parser/treesitter.go"
      via: "Pipeline creates Tree-sitter parser for non-Go targets"
      pattern: "TreeSitterParser"
    - from: "cmd/scan.go"
      to: "internal/config/config.go"
      via: "CLI loads .arsrc.yml config"
      pattern: "LoadProjectConfig"
---

<objective>
Implement C2 Python and TypeScript analyzers using Tree-sitter, build the .arsrc.yml config system, wire multi-language analysis into the pipeline and CLI, and update output rendering.

Purpose: This is the final plan that delivers the complete Phase 6 user experience: multi-language C2 analysis with configurable scoring.
Output: Working C2 analysis for all 3 languages, config system, updated CLI and output.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-multi-language-foundation/06-RESEARCH.md
@.planning/phases/06-multi-language-foundation/06-01-SUMMARY.md
@.planning/phases/06-multi-language-foundation/06-02-SUMMARY.md
@.planning/phases/06-multi-language-foundation/06-03-SUMMARY.md

@internal/analyzer/c2_semantics.go
@internal/analyzer/c2_go.go
@internal/parser/treesitter.go
@internal/pipeline/pipeline.go
@internal/output/terminal.go
@internal/output/json.go
@cmd/scan.go
@pkg/types/types.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement C2 Python and TypeScript analyzers</name>
  <files>
    internal/analyzer/c2_python.go
    internal/analyzer/c2_python_test.go
    internal/analyzer/c2_typescript.go
    internal/analyzer/c2_typescript_test.go
    internal/analyzer/c2_semantics.go
  </files>
  <action>
1. Create `internal/analyzer/c2_python.go` -- `C2PythonAnalyzer`:
   - Accepts a `*parser.TreeSitterParser` in constructor
   - `Analyze(target *types.AnalysisTarget) (*types.C2LanguageMetrics, error)`
   - For each .py source file in target.Files (skip test files), parse with Tree-sitter

   **C2-PY-01: Type annotation coverage**
   - Use Tree-sitter queries to count:
     - Functions with return_type annotation vs without
     - typed_parameter vs plain identifier parameters
     - Exclude `self` and `cls` parameters from count
   - Score: (annotated_params + annotated_returns) / (total_params + total_functions) * 100

   **C2-PY-02: Naming consistency (PEP 8)**
   - Function/method names: must be snake_case (lowercase with underscores)
   - Class names: must be CamelCase (start with uppercase)
   - Variable names in assignments: must be snake_case (except UPPER_CASE constants)
   - Use Tree-sitter to capture identifier nodes with parent context
   - Score: percentage following convention

   **C2-PY-03: Magic numbers**
   - Tree-sitter query for `(integer)` and `(float)` nodes
   - Exclude: inside assignment to UPPER_CASE names, values 0/1/-1/2/100, inside list/dict indices
   - Report: per 1000 LOC

   **C2-PY-04: mypy/pyright config detection**
   - Check for: mypy.ini, .mypy.ini, setup.cfg with [mypy] section, pyproject.toml with [tool.mypy], pyrightconfig.json, pyproject.toml with [tool.pyright]
   - TypeStrictness: 1 if any type checker config found, 0 otherwise

   Close all Tree-sitter trees after analysis (defer tree.Close() per file).

2. Create `internal/analyzer/c2_typescript.go` -- `C2TypeScriptAnalyzer`:
   - Accepts a `*parser.TreeSitterParser` in constructor
   - `Analyze(target *types.AnalysisTarget) (*types.C2LanguageMetrics, error)`

   **C2-TS-01: Type annotation coverage**
   - Tree-sitter queries for functions/arrow functions with vs without return_type
   - Count parameters with type annotations vs without
   - Count explicit `any` type identifiers (penalty)
   - Score: (typed_elements - any_count) / total_elements * 100

   **C2-TS-02: tsconfig.json strict mode**
   - Parse tsconfig.json from target.RootDir
   - Check compilerOptions: strict, strictNullChecks, noImplicitAny, strictFunctionTypes
   - TypeStrictness: 1 if strict == true OR all individual strict flags are true, else 0
   - Also contributes to NullSafety score (strictNullChecks)

   **C2-TS-03: Magic numbers**
   - Tree-sitter query for `(number)` nodes
   - Exclude: inside const declarations, enum members, values 0/1/-1
   - Report: per 1000 LOC

   **C2-TS-04: Null safety**
   - Count optional chaining `?.` usage (Tree-sitter: `optional_chain`)
   - Check strictNullChecks in tsconfig
   - NullSafety score: combination of strictNullChecks flag + optional chaining density

   Use file extension to select TS vs TSX grammar (.ts -> TypeScript, .tsx -> TSX).
   Close all Tree-sitter trees after analysis.

3. Update `internal/analyzer/c2_semantics.go`:
   - Add `pyAnalyzer *C2PythonAnalyzer` and `tsAnalyzer *C2TypeScriptAnalyzer` fields to C2Analyzer
   - In Analyze(), dispatch Python targets to pyAnalyzer and TypeScript targets to tsAnalyzer
   - Aggregate per-language results into C2Metrics.Aggregate weighted by LOC proportion
   - C2Analyzer constructor accepts a TreeSitterParser

4. Write tests:
   - `c2_python_test.go`: test against testdata/valid-python-project. Verify type annotation coverage > 0, naming consistency > 0, magic number detection works.
   - `c2_typescript_test.go`: test against testdata/valid-ts-project. Verify type coverage > 0, strict mode detected from tsconfig.json, magic numbers found.
  </action>
  <verify>
`cd /Users/ingo/agent-readyness && CGO_ENABLED=1 go test ./internal/analyzer/... -v -run C2` -- all C2 tests pass for Go, Python, and TypeScript
  </verify>
  <done>C2 Python analyzer measures type annotations, naming, magic numbers, mypy config. C2 TypeScript analyzer measures type coverage, tsconfig strict, magic numbers, null safety. C2Analyzer dispatches to all three languages and aggregates results.</done>
</task>

<task type="auto">
  <name>Task 2: Config system, pipeline wiring, CLI, and output updates</name>
  <files>
    internal/config/config.go
    internal/config/config_test.go
    internal/pipeline/pipeline.go
    internal/output/terminal.go
    internal/output/json.go
    cmd/scan.go
  </files>
  <action>
1. Create `internal/config/config.go`:
   - `ProjectConfig` struct with fields: Version int, Scoring (Weights map[string]float64, Threshold float64), Languages []string, Metrics map[string]MetricOverrides
   - `MetricOverrides` struct: Enabled *bool, custom threshold values per language
   - `LoadProjectConfig(dir string, explicitPath string) (*ProjectConfig, error)`:
     - If explicitPath provided (--config flag), load that file
     - Else look for `.arsrc.yml` in dir, then `.arsrc.yaml`
     - If not found, return nil (no config, use defaults)
     - Use yaml.NewDecoder with KnownFields(true) for strict parsing
   - `Validate() error` method: check version == 1, weights >= 0, threshold >= 0
   - `ApplyToScoringConfig(sc *scoring.ScoringConfig)` method: override weights from config, validate constraints
   - `DefaultProjectConfig() *ProjectConfig` returns sensible defaults

2. Write `internal/config/config_test.go`:
   - Test loading valid .arsrc.yml
   - Test strict parsing rejects unknown fields
   - Test missing file returns nil (no error)
   - Test validation catches invalid weights

3. Update `internal/pipeline/pipeline.go`:
   - Pipeline.New() now also accepts optional `*parser.TreeSitterParser` (or creates one internally)
   - In Run():
     - After Go parsing, also check for Python/TypeScript targets
     - If Python or TypeScript files discovered, create AnalysisTargets for each language by reading file contents
     - Register C2Analyzer (with TreeSitterParser) alongside existing C1/C3/C6 analyzers
     - Pass all AnalysisTargets to analyzers
     - Close TreeSitterParser after analysis completes (defer)
   - Remove `validateGoProject()` call from scan.go -- move validation to pipeline (support non-Go projects)
   - If no Go files found, skip Go parsing (don't error)
   - If no files found for any language, return clear error

4. Update `cmd/scan.go`:
   - Remove `validateGoProject()` -- replace with generic project validation (dir exists, has recognized source files)
   - Add `--config` flag (already exists but currently only for scoring config -- extend to load .arsrc.yml)
   - Update `--verbose` to show per-language file counts and C2 details
   - Ensure CGO_ENABLED requirement is documented in error message if Tree-sitter fails to load

5. Update `internal/output/terminal.go`:
   - Render C2 category score alongside C1/C3/C6
   - In verbose mode, show per-language C2 breakdown (Go: 9.2, Python: 7.1, TypeScript: 8.5)
   - Show per-language file counts in summary

6. Update `internal/output/json.go`:
   - Include C2 category in JSON output
   - Add per-language breakdown in verbose JSON mode
  </action>
  <verify>
Run full test suite: `cd /Users/ingo/agent-readyness && CGO_ENABLED=1 go test ./... -v 2>&1`

Then integration tests:
- `CGO_ENABLED=1 go build -o /tmp/ars ./main.go`
- `/tmp/ars scan .` -- shows C1, C2, C3, C6 scores for Go project
- `/tmp/ars scan ./testdata/valid-python-project` -- shows C2 scores for Python
- `/tmp/ars scan ./testdata/valid-ts-project` -- shows C2 scores for TypeScript
- `/tmp/ars scan ./testdata/polyglot-project` -- shows per-language C2 analysis
- `/tmp/ars scan ./testdata/valid-python-project --verbose` -- shows detailed per-language breakdown
  </verify>
  <done>Config system loads .arsrc.yml with validation. Pipeline runs multi-language analysis. CLI accepts Python/TypeScript projects. Output shows C2 scores and per-language details. All phase 6 success criteria met.</done>
</task>

</tasks>

<verification>
1. `CGO_ENABLED=1 go build ./...` succeeds
2. `CGO_ENABLED=1 go test ./...` all tests pass
3. `ars scan` on Python project shows C2 scores
4. `ars scan` on TypeScript project shows C2 scores
5. `ars scan` on polyglot project shows per-language C2
6. `.arsrc.yml` config is loaded and applied
7. `--verbose` shows per-language details
8. Performance: scan completes in under 30 seconds on test fixtures
</verification>

<success_criteria>
- Phase 6 success criteria 1: Python project C2 scores visible
- Phase 6 success criteria 2: TypeScript project C2 scores visible
- Phase 6 success criteria 3: Mixed-language repo shows per-language C2
- Phase 6 success criteria 4: .arsrc.yml config customizes weights and thresholds
- Phase 6 success criteria 5: Non-LLM analysis under 30 seconds
- All existing Go analysis unchanged
- No memory leaks from Tree-sitter (all Close() calls in place)
</success_criteria>

<output>
After completion, create `.planning/phases/06-multi-language-foundation/06-04-SUMMARY.md`
</output>
