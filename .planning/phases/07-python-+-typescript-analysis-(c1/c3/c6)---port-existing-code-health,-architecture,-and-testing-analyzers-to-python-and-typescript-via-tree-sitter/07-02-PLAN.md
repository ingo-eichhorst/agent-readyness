---
phase: 07-python-typescript-c1-c3-c6
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - internal/analyzer/c1_codehealth.go
  - internal/analyzer/c1_typescript.go
  - internal/analyzer/c1_typescript_test.go
  - internal/analyzer/c3_architecture.go
  - internal/analyzer/c3_typescript.go
  - internal/analyzer/c3_typescript_test.go
  - internal/analyzer/c6_testing.go
  - internal/analyzer/c6_typescript.go
  - internal/analyzer/c6_typescript_test.go
  - testdata/valid-ts-project/src/app.ts
  - testdata/valid-ts-project/src/utils.ts
  - testdata/valid-ts-project/src/app.test.ts
autonomous: true

must_haves:
  truths:
    - "User runs ars scan on a TypeScript project and sees C1 scores (complexity, function length, file size, duplication)"
    - "User runs ars scan on a TypeScript project and sees C3 scores (import graph, dead code, directory depth)"
    - "User runs ars scan on a TypeScript project and sees C6 scores with Jest/Vitest/Mocha detection"
    - "User runs ars scan on a polyglot repo and sees per-language analysis merged into unified scores"
    - "Existing Go and Python analysis completely unchanged"
  artifacts:
    - path: "internal/analyzer/c1_typescript.go"
      provides: "TypeScript C1 analysis via Tree-sitter"
      exports: ["tsAnalyzeFunctions", "tsAnalyzeFileSizes", "tsAnalyzeDuplication"]
    - path: "internal/analyzer/c3_typescript.go"
      provides: "TypeScript C3 analysis via Tree-sitter"
      exports: ["tsBuildImportGraph", "tsDetectDeadCode", "tsAnalyzeDirectoryDepth"]
    - path: "internal/analyzer/c6_typescript.go"
      provides: "TypeScript C6 analysis via Tree-sitter"
      exports: ["tsDetectTests", "tsCountAssertions"]
  key_links:
    - from: "internal/analyzer/c1_codehealth.go"
      to: "internal/analyzer/c1_typescript.go"
      via: "C1Analyzer.Analyze dispatches to TypeScript analysis for LangTypeScript targets"
      pattern: "case types\\.LangTypeScript"
    - from: "internal/analyzer/c3_architecture.go"
      to: "internal/analyzer/c3_typescript.go"
      via: "C3Analyzer.Analyze dispatches to TypeScript analysis for LangTypeScript targets"
      pattern: "case types\\.LangTypeScript"
    - from: "internal/analyzer/c6_testing.go"
      to: "internal/analyzer/c6_typescript.go"
      via: "C6Analyzer.Analyze dispatches to TypeScript analysis for LangTypeScript targets"
      pattern: "case types\\.LangTypeScript"
---

<objective>
Implement TypeScript C1/C3/C6 analyzers, extending the dispatchers already refactored in Plan 01 for Python.

Purpose: Complete Phase 7 by adding TypeScript code health, architecture, and testing analysis. After this plan, all three languages (Go, Python, TypeScript) have full C1/C3/C6 coverage.

Output: Six new files (c1_typescript.go, c3_typescript.go, c6_typescript.go + tests), updated dispatchers with TypeScript cases, enriched testdata.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-python-+-typescript-analysis-(c1/c3/c6)---port-existing-code-health,-architecture,-and-testing-analyzers-to-python-and-typescript-via-tree-sitter/07-RESEARCH.md
@.planning/phases/07-python-+-typescript-analysis-(c1/c3/c6)---port-existing-code-health,-architecture,-and-testing-analyzers-to-python-and-typescript-via-tree-sitter/07-01-SUMMARY.md

# Key source files -- read the Plan 01 output to understand the dispatcher pattern
@internal/analyzer/c1_codehealth.go
@internal/analyzer/c1_python.go
@internal/analyzer/c3_architecture.go
@internal/analyzer/c3_python.go
@internal/analyzer/c6_testing.go
@internal/analyzer/c6_python.go
@internal/analyzer/c2_typescript.go
@internal/analyzer/helpers.go
@internal/pipeline/pipeline.go
@pkg/types/types.go
@internal/parser/treesitter.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement TypeScript C1/C3/C6 analyzers</name>
  <files>
    internal/analyzer/c1_codehealth.go
    internal/analyzer/c1_typescript.go
    internal/analyzer/c1_typescript_test.go
    internal/analyzer/c3_architecture.go
    internal/analyzer/c3_typescript.go
    internal/analyzer/c3_typescript_test.go
    internal/analyzer/c6_testing.go
    internal/analyzer/c6_typescript.go
    internal/analyzer/c6_typescript_test.go
  </files>
  <action>
    Follow the EXACT same pattern as the Python analyzers created in Plan 01, but adapted for TypeScript syntax. Read the Plan 01 Python files first to match the pattern precisely.

    **Create c1_typescript.go:**
    - `tsAnalyzeFunctions(files []*parser.ParsedTreeSitterFile) []types.FunctionMetric` -- Find all `function_declaration`, `method_definition`, `arrow_function` nodes. For arrow functions, get name from parent `variable_declarator`. For methods, prefix with class name. Compute cyclomatic complexity counting: if_statement, for_statement, for_in_statement, while_statement, do_statement, switch_case, catch_clause, ternary_expression, and binary_expression with &&/||/?? operators. Skip nested function_declaration/arrow_function when counting complexity.
    - `tsAnalyzeFileSizes(files []*parser.ParsedTreeSitterFile) types.MetricSummary`
    - `tsAnalyzeDuplication(files []*parser.ParsedTreeSitterFile) ([]types.DuplicateBlock, float64)` -- Hash over `statement_block` children (same sliding window algorithm as Python but with `statement_block` instead of `block`).

    **Create c3_typescript.go:**
    - `tsBuildImportGraph(files []*parser.ParsedTreeSitterFile) *ImportGraph` -- Parse both ESM (`import_statement` with `source` field) and CommonJS (`call_expression` with `require` function). Parse tsconfig.json for path aliases (`paths` and `baseUrl`) if present in the rootDir. Resolve relative imports to file paths. Only track intra-project imports (skip node_modules). See RESEARCH.md Pattern 3.
    - `tsDetectDeadCode(files []*parser.ParsedTreeSitterFile) []types.DeadExport` -- Find `export_statement` children (exported functions, classes, consts). Check which exported names are imported by other project files.
    - `tsAnalyzeDirectoryDepth(files []*parser.ParsedTreeSitterFile, rootDir string) (int, float64)`
    - Use same ImportGraph struct, detectCircularDeps, fanout analysis from helpers.go.

    **Create c6_typescript.go:**
    - `tsDetectTests(files []*parser.ParsedTreeSitterFile) ([]types.TestFunctionMetric, int, int)` -- Scan test files (*.test.ts, *.spec.ts, __tests__/*.ts) for `call_expression` nodes where function name is `describe`, `it`, `test`. Count assertions: `expect().toBe/toEqual/etc` patterns (call_expression chains with `expect` as outer function).
    - `tsAnalyzeIsolation(files []*parser.ParsedTreeSitterFile, testFuncs []types.TestFunctionMetric) float64` -- Check test file imports for network/db libraries (axios, fetch, pg, mysql, mongoose, etc.).
    - Coverage: reuse existing `parseCoverage()` -- it already handles LCOV (Istanbul/NYC output).
    - Test-to-code ratio from source vs test file LOC.

    **Update dispatchers (c1_codehealth.go, c3_architecture.go, c6_testing.go):**
    Add `case types.LangTypeScript:` dispatch in each Analyze method, calling the new TypeScript functions. This should be trivial since Plan 01 already restructured these to dispatch by language.

    **Tests:**
    - Extend testdata: add `testdata/valid-ts-project/src/utils.ts` with complex functions and `testdata/valid-ts-project/src/app.test.ts` with Jest-style tests.
    - c1_typescript_test.go: test complexity (function_declaration, arrow_function, method_definition), function length, duplication
    - c3_typescript_test.go: test ESM and CommonJS import graph building, dead exports detection, directory depth
    - c6_typescript_test.go: test Jest/Vitest test detection (describe/it/test patterns), assertion counting (expect chains)
  </action>
  <verify>
    Run `go test ./internal/analyzer/... -v -run "TypeScript|TS|Ts"` -- all new TypeScript tests pass.
    Run `go test ./...` -- ALL existing tests still pass (Go + Python analysis unchanged).
    Run `go build ./...` -- project compiles.
  </verify>
  <done>
    TypeScript C1/C3/C6 analyzer files exist with tests. Dispatchers handle LangTypeScript targets. Go and Python tests unchanged and passing.
  </done>
</task>

<task type="auto">
  <name>Task 2: End-to-end verification across all languages</name>
  <files>
    testdata/valid-ts-project/src/app.ts
    testdata/valid-ts-project/src/utils.ts
  </files>
  <action>
    Verify end-to-end pipeline for TypeScript and polyglot scenarios:

    1. Ensure testdata/valid-ts-project has enough complexity for meaningful scores:
       - `src/app.ts` should have functions with control flow (if/for/switch), imports from `./utils`
       - `src/utils.ts` should have exported functions, some dead exports (not imported anywhere)
       - `src/app.test.ts` should have describe/it blocks with expect assertions

    2. Run the full pipeline on each testdata project and verify output:
       - `go build ./cmd/... && ./ars scan testdata/valid-ts-project --verbose` -- shows C1, C2, C3, C6 scores
       - `go build ./cmd/... && ./ars scan testdata/valid-python-project --verbose` -- shows C1, C2, C3, C6 scores
       - `go build ./cmd/... && ./ars scan testdata/valid-go-project --verbose` -- Go analysis unchanged
       - `go build ./cmd/... && ./ars scan testdata/polyglot-project --verbose` -- shows merged multi-language scores (if polyglot testdata exists)

    3. Verify JSON output mode works: `./ars scan testdata/valid-ts-project --json` should include all categories.

    4. Run full test suite one final time: `go test ./... -count=1`

    Fix any issues discovered during end-to-end testing (output formatting, metric merging edge cases, etc.).
  </action>
  <verify>
    Run `go test ./... -count=1` -- all tests pass.
    Run `./ars scan testdata/valid-ts-project --verbose` -- non-zero C1, C3, C6 scores visible.
    Run `./ars scan testdata/valid-python-project --verbose` -- non-zero C1, C3, C6 scores visible.
    Run `./ars scan testdata/valid-go-project --verbose` -- output identical to before Phase 7.
  </verify>
  <done>
    All three languages produce C1, C3, C6 scores. Polyglot projects show merged scores. JSON output includes all categories. Full test suite passes. Phase 7 success criteria met.
  </done>
</task>

</tasks>

<verification>
1. `go test ./...` passes with 0 failures
2. `go build ./cmd/...` compiles without errors
3. TypeScript projects show C1 scores: cyclomatic complexity, function length, file size, duplication
4. TypeScript projects show C3 scores: directory depth, import graph, dead exports
5. TypeScript projects show C6 scores: test detection (Jest/Vitest/Mocha patterns), assertion density
6. Go and Python projects produce identical output to Plan 01 results
7. Phase 7 success criteria (ROADMAP.md) are fully met
</verification>

<success_criteria>
- Requirements TS-01 through TS-09 addressed (TypeScript C1/C3/C6 analysis)
- All new TypeScript analyzer files have corresponding test files
- Go and Python analysis completely unaffected
- Polyglot projects show merged multi-language scores
- Phase 7 complete: all three languages have full C1/C3/C6 coverage
</success_criteria>

<output>
After completion, create `.planning/phases/07-python-+-typescript-analysis-(c1/c3/c6)---port-existing-code-health,-architecture,-and-testing-analyzers-to-python-and-typescript-via-tree-sitter/07-02-SUMMARY.md`
</output>
