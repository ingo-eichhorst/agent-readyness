---
phase: 08-c5-temporal-dynamics
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - pkg/types/types.go
  - internal/analyzer/c5_temporal.go
  - internal/scoring/config.go
  - internal/scoring/scorer.go
  - internal/recommend/recommend.go
  - internal/pipeline/pipeline.go
autonomous: true

must_haves:
  truths:
    - "C5 analyzer parses git log output and computes churn rate, temporal coupling, author fragmentation, commit stability, and hotspot concentration"
    - "C5 returns Available=false with no error when .git directory is missing"
    - "C5 skips binary files and commits with >50 files to avoid false positives"
    - "C5 scoring config uses breakpoint interpolation consistent with C1/C2/C3/C6"
    - "Pipeline includes C5 analyzer and produces C5 scores in output"
  artifacts:
    - path: "pkg/types/types.go"
      provides: "C5Metrics, FileChurn, CoupledPair structs"
      contains: "C5Metrics"
    - path: "internal/analyzer/c5_temporal.go"
      provides: "C5Analyzer with git log parsing and all metric calculations"
      exports: ["NewC5Analyzer"]
    - path: "internal/scoring/config.go"
      provides: "C5 category in DefaultConfig"
      contains: "Temporal Dynamics"
    - path: "internal/scoring/scorer.go"
      provides: "extractC5 function registered in metricExtractors"
      contains: "extractC5"
  key_links:
    - from: "internal/analyzer/c5_temporal.go"
      to: "pkg/types/types.go"
      via: "C5Metrics struct usage"
      pattern: "types\\.C5Metrics"
    - from: "internal/scoring/scorer.go"
      to: "internal/analyzer/c5_temporal.go"
      via: "extractC5 reads C5Metrics from AnalysisResult"
      pattern: "extractC5"
    - from: "internal/pipeline/pipeline.go"
      to: "internal/analyzer/c5_temporal.go"
      via: "NewC5Analyzer in analyzers slice"
      pattern: "NewC5Analyzer"
---

<objective>
Implement the C5 Temporal Dynamics analyzer: git log parsing, all 5 metric computations, scoring configuration, extractor, recommendations, and pipeline wiring.

Purpose: Enable `ars scan` to produce C5 temporal dynamics scores from git history analysis.
Output: Working C5 analyzer integrated into the scan pipeline with scoring and recommendations.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/08-c5-temporal-dynamics/08-RESEARCH.md
@pkg/types/types.go
@internal/analyzer/c6_testing.go
@internal/scoring/config.go
@internal/scoring/scorer.go
@internal/recommend/recommend.go
@internal/pipeline/pipeline.go
@internal/pipeline/interfaces.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: C5Metrics types + C5Analyzer with git log parsing and metric calculations</name>
  <files>
    pkg/types/types.go
    internal/analyzer/c5_temporal.go
  </files>
  <action>
1. Add C5 types to `pkg/types/types.go` (append after C6Metrics):

```go
// C5Metrics holds Temporal & Operational Dynamics metric results.
type C5Metrics struct {
    Available            bool
    ChurnRate            float64       // avg lines changed per commit (90-day window)
    TemporalCouplingPct  float64       // % of file pairs with >70% co-change rate
    AuthorFragmentation  float64       // avg distinct authors per file (90-day window)
    CommitStability      float64       // median days between changes per file
    HotspotConcentration float64       // % of total changes in top 10% of files
    TopHotspots          []FileChurn   // top churning files (up to 10)
    CoupledPairs         []CoupledPair // detected temporal couplings
    TotalCommits         int
    TimeWindowDays       int
}

type FileChurn struct {
    Path         string
    TotalChanges int
    CommitCount  int
    AuthorCount  int
}

type CoupledPair struct {
    FileA         string
    FileB         string
    Coupling      float64 // 0-100 percentage
    SharedCommits int
}
```

2. Create `internal/analyzer/c5_temporal.go` with:

- `C5Analyzer` struct (no fields needed -- no Tree-sitter dependency).
- `NewC5Analyzer() *C5Analyzer` constructor.
- `Name() string` returning `"C5: Temporal Dynamics"`.
- `Analyze(targets []*types.AnalysisTarget) (*types.AnalysisResult, error)`:
  - Extract `rootDir` from `targets[0].RootDir`.
  - Check for `.git` directory with `os.Stat`. If missing, return result with `Available: false` (NOT an error).
  - Call `analyzeGitHistory(rootDir, 6)` (6-month window).
  - Return `AnalysisResult` with Category `"C5"` and metrics keyed as `"c5"`.

- Internal types: `commitInfo{Hash, Author, Timestamp string/int64, Files []fileChange}`, `fileChange{Added, Deleted int, Path string}`.

- `runGitLog(rootDir string, months int) ([]commitInfo, error)`:
  - Use `exec.CommandContext` with 25-second timeout.
  - Command: `git log --pretty=format:%H|%ae|%at --numstat --since='{months} months ago' --no-merges`
  - Set `cmd.Dir = rootDir`.
  - Stream parse with `bufio.Scanner` from `StdoutPipe`:
    - Lines with `|` and 3 parts = header (hash|author|timestamp).
    - Lines with `\t` and 3 parts = numstat (added\tdeleted\tpath).
    - Handle binary files: skip lines where added or deleted is `-`.
    - Handle renames: if path contains `{` and `=>`, extract new path. Pattern: `prefix{old => new}suffix` becomes `prefix + new + suffix`.
    - Empty line = commit boundary.
  - Read ALL output from pipe THEN call `cmd.Wait()`.
  - Return empty slice (not error) if no commits found.

- `analyzeGitHistory(rootDir string, months int) (*types.C5Metrics, error)`:
  - Call `runGitLog`, return error if git fails.
  - If no commits, return `C5Metrics{Available: false}`.
  - Compute all 5 metrics from parsed commits:
    - `calcChurnRate(commits, 90)` -- 90-day window, avg lines changed per commit.
    - `calcTemporalCoupling(commits, 5, 50)` -- min 5 commits per file, skip commits >50 files.
    - `calcAuthorFragmentation(commits, 90)` -- 90-day window.
    - `calcCommitStability(commits)` -- median days between changes across all files.
    - `calcHotspotConcentration(commits)` -- % of changes in top 10% of files.
  - Populate `TopHotspots` (up to 10) and `CoupledPairs` from calculation results.
  - Set `TotalCommits = len(commits)`, `TimeWindowDays = months * 30`.

Follow the metric calculation pseudocode from 08-RESEARCH.md exactly. Key details:
- Churn rate: sum (added+deleted) for commits within 90-day window, divide by commit count.
- Temporal coupling: for each commit with <=50 files, count file pairs' co-occurrences. Strength = sharedCommits / min(commitsA, commitsB) * 100. Report % of qualified pairs above 70%.
- Author fragmentation: map each file to set of authors within 90-day window. Average set size.
- Commit stability: for each file, sort timestamps, compute inter-change intervals in days. Take median of all intervals. Default 30 if no repeat changes.
- Hotspot concentration: sort files by total changes descending. Sum top 10% files' changes / total changes * 100.

Use `filepath.ToSlash()` for path normalization. Use `sort.Float64s` for median calculation.
  </action>
  <verify>
Run `go build ./...` -- should compile with no errors.
Run `go vet ./internal/analyzer/` -- no issues.
  </verify>
  <done>
C5Metrics/FileChurn/CoupledPair types exist in types.go. C5Analyzer implements the Analyzer interface with git log parsing, all 5 metric calculations, binary file handling, rename handling, large commit filtering, and graceful .git-missing behavior.
  </done>
</task>

<task type="auto">
  <name>Task 2: Scoring config + extractor + recommendations + pipeline wiring</name>
  <files>
    internal/scoring/config.go
    internal/scoring/scorer.go
    internal/recommend/recommend.go
    internal/pipeline/pipeline.go
  </files>
  <action>
1. In `internal/scoring/config.go`, add C5 to `DefaultConfig()` Categories map (after C3, before C6):

```go
"C5": {
    Name:   "Temporal Dynamics",
    Weight: 0.10,
    Metrics: []MetricThresholds{
        {Name: "churn_rate", Weight: 0.20, Breakpoints: []Breakpoint{
            {Value: 50, Score: 10}, {Value: 100, Score: 8}, {Value: 300, Score: 6}, {Value: 600, Score: 3}, {Value: 1000, Score: 1},
        }},
        {Name: "temporal_coupling_pct", Weight: 0.25, Breakpoints: []Breakpoint{
            {Value: 0, Score: 10}, {Value: 5, Score: 8}, {Value: 15, Score: 6}, {Value: 25, Score: 3}, {Value: 30, Score: 1},
        }},
        {Name: "author_fragmentation", Weight: 0.20, Breakpoints: []Breakpoint{
            {Value: 1, Score: 10}, {Value: 2, Score: 8}, {Value: 4, Score: 6}, {Value: 6, Score: 3}, {Value: 8, Score: 1},
        }},
        {Name: "commit_stability", Weight: 0.15, Breakpoints: []Breakpoint{
            {Value: 0.5, Score: 1}, {Value: 1, Score: 3}, {Value: 3, Score: 6}, {Value: 7, Score: 8}, {Value: 14, Score: 10},
        }},
        {Name: "hotspot_concentration", Weight: 0.20, Breakpoints: []Breakpoint{
            {Value: 20, Score: 10}, {Value: 30, Score: 8}, {Value: 50, Score: 6}, {Value: 70, Score: 3}, {Value: 80, Score: 1},
        }},
    },
},
```

2. In `internal/scoring/scorer.go`:
- Add `"C5": extractC5` to the `metricExtractors` map initialization.
- Add `extractC5` function following the exact pattern from research:
  - Get `ar.Metrics["c5"]`, cast to `*types.C5Metrics`.
  - If `!m.Available`, return empty map + all 5 metrics in unavailable set.
  - Otherwise return map with churn_rate, temporal_coupling_pct, author_fragmentation, commit_stability, hotspot_concentration.

3. In `internal/recommend/recommend.go`:
- Add C5 entries to `agentImpact` map:
  - `"churn_rate"`: "High code churn indicates unstable areas where agent changes are more likely to conflict"
  - `"temporal_coupling_pct"`: "Tightly coupled files force agents to understand and modify multiple files simultaneously"
  - `"author_fragmentation"`: "Many authors per file means inconsistent patterns that confuse agent understanding"
  - `"commit_stability"`: "Frequently changing files increase the chance of agent merge conflicts"
  - `"hotspot_concentration"`: "Concentrated changes mean agents repeatedly work in the same complex areas"
- Add C5 entries to `actionTemplates` map:
  - `"churn_rate"`: "Stabilize high-churn files (avg %.0f lines/commit) by breaking up large changes"
  - `"temporal_coupling_pct"`: "Decouple files that change together (%.1f%% coupling) by extracting shared interfaces"
  - `"author_fragmentation"`: "Improve code ownership (avg %.1f authors/file) by assigning clear module owners"
  - `"commit_stability"`: "Stabilize frequently changing files (median %.1f days between changes)"
  - `"hotspot_concentration"`: "Distribute changes more evenly (top 10%% of files contain %.0f%% of changes)"
- Add C5 entries to `displayNames` map:
  - `"churn_rate"`: "code churn rate"
  - `"temporal_coupling_pct"`: "temporal coupling"
  - `"author_fragmentation"`: "author fragmentation"
  - `"commit_stability"`: "commit stability"
  - `"hotspot_concentration"`: "hotspot concentration"
- Add C5 metric cases to `buildAction` switch statement matching the template format strings.

4. In `internal/pipeline/pipeline.go`:
- Add `analyzer.NewC5Analyzer()` to the analyzers slice in `New()`, between C3 and C6:
  ```go
  analyzer.NewC3Analyzer(tsParser),
  analyzer.NewC5Analyzer(), // No tsParser needed - git-based analysis
  analyzer.NewC6Analyzer(tsParser),
  ```
- Update the sort comment from `(C1, C2, C3, C6)` to `(C1, C2, C3, C5, C6)`.
  </action>
  <verify>
Run `go build ./...` -- should compile with no errors.
Run `go vet ./...` -- no issues.
  </verify>
  <done>
C5 scoring config with 5 metrics and breakpoints exists in DefaultConfig. extractC5 registered in metricExtractors. C5 recommendations (impact, actions, display names) in recommend.go. Pipeline includes C5Analyzer in the analyzers slice.
  </done>
</task>

</tasks>

<verification>
- `go build ./...` compiles successfully
- `go vet ./...` reports no issues
- C5 analyzer implements the `pipeline.Analyzer` interface
- DefaultConfig includes C5 with correct weight (0.10) and 5 metrics
- extractC5 registered in metricExtractors map
- Pipeline.New() includes NewC5Analyzer()
</verification>

<success_criteria>
- C5Analyzer fully implemented with git log parsing and 5 metric calculations
- Graceful handling of missing .git, binary files, renamed files, large commits, empty history
- Scoring, extraction, recommendations, and pipeline integration complete
- `go build ./...` passes
</success_criteria>

<output>
After completion, create `.planning/phases/08-c5-temporal-dynamics/08-01-SUMMARY.md`
</output>
