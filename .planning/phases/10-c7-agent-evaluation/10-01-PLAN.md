---
phase: 10-c7-agent-evaluation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - internal/agent/types.go
  - internal/agent/executor.go
  - internal/agent/tasks.go
  - internal/agent/workspace.go
  - internal/agent/executor_test.go
autonomous: true

must_haves:
  truths:
    - "Claude CLI is invoked as a subprocess with proper timeout handling"
    - "Tasks are executed sequentially with captured JSON output"
    - "Isolated workspace is created to prevent modifications to user's codebase"
    - "CLI unavailability is detected before execution begins"
  artifacts:
    - path: "internal/agent/types.go"
      provides: "C7 task and result types"
      exports: ["Task", "TaskResult", "TaskStatus"]
    - path: "internal/agent/executor.go"
      provides: "Claude CLI subprocess management with graceful timeout"
      exports: ["Executor", "NewExecutor", "CheckClaudeCLI"]
    - path: "internal/agent/tasks.go"
      provides: "4 standardized task definitions with prompts"
      exports: ["AllTasks", "IntentClarityTask", "ModificationConfidenceTask", "CrossFileCoherenceTask", "SemanticCompletenessTask"]
    - path: "internal/agent/workspace.go"
      provides: "Isolated git worktree creation for agent execution"
      exports: ["CreateWorkspace"]
  key_links:
    - from: "internal/agent/executor.go"
      to: "claude CLI"
      via: "exec.CommandContext subprocess"
      pattern: "exec\\.CommandContext.*claude"
    - from: "internal/agent/workspace.go"
      to: "git worktree"
      via: "git worktree add command"
      pattern: "git.*worktree.*add"
---

<objective>
Create the agent execution infrastructure for C7 evaluation: types, Claude CLI subprocess management with graceful timeout, task definitions, and workspace isolation.

Purpose: Establishes the foundation for genuine agent-in-the-loop evaluation by enabling ARS to invoke headless Claude Code against user codebases.
Output: internal/agent package with executor, tasks, workspace management, and comprehensive tests.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/10-c7-agent-evaluation/10-CONTEXT.md
@.planning/phases/10-c7-agent-evaluation/10-RESEARCH.md
@internal/analyzer/c5_temporal.go (subprocess pattern with context.WithTimeout)
@internal/llm/client.go (existing LLM patterns)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create agent package types and executor</name>
  <files>
    internal/agent/types.go
    internal/agent/executor.go
  </files>
  <action>
Create internal/agent/types.go with:
- Task struct: ID, Name, Description, Prompt (the task prompt to send to Claude), ToolsAllowed (Read,Glob,Grep,Bash,Edit), TimeoutSeconds (default 300)
- TaskResult struct: TaskID, Status (completed/timeout/error/cli_not_found), Response (agent's text response), SessionID, StartTime, EndTime, Error
- TaskStatus type: string enum for completed/timeout/error/cli_not_found
- C7EvaluationResult struct: Tasks []TaskResult, TotalDuration time.Duration, CLIAvailable bool

Create internal/agent/executor.go with:
- Executor struct: workDir string (isolated workspace path)
- NewExecutor(workDir string) *Executor
- CheckClaudeCLI() error: Uses exec.LookPath("claude") to verify CLI is installed. Returns descriptive error with installation instructions if not found.
- (e *Executor) ExecuteTask(ctx context.Context, task Task) TaskResult:
  - Creates context with task.TimeoutSeconds timeout
  - Builds command: exec.CommandContext(ctx, "claude", "-p", task.Prompt, "--output-format", "json", "--allowedTools", task.ToolsAllowed)
  - Sets cmd.Dir = e.workDir
  - Sets cmd.Cancel to send SIGINT (graceful shutdown per Go 1.20+)
  - Sets cmd.WaitDelay = 10 * time.Second (grace period before force kill)
  - Captures both stdout and stderr via cmd.CombinedOutput()
  - Handles context.DeadlineExceeded -> TaskResult{Status: "timeout"}
  - Handles non-zero exit -> TaskResult{Status: "error", Error: stderr content}
  - Parses JSON output to extract result field
  - Returns TaskResult with status, response, timing

Pattern from RESEARCH.md:
```go
cmd.Cancel = func() error {
    return cmd.Process.Signal(os.Interrupt)
}
cmd.WaitDelay = 10 * time.Second
```

JSON response parsing (handle both stdout JSON and error cases):
```go
type CLIResponse struct {
    Type      string `json:"type"`
    SessionID string `json:"session_id"`
    Result    string `json:"result"`
}
```

Do NOT use cmd.Output() - use cmd.CombinedOutput() to capture stderr for error diagnosis.
  </action>
  <verify>
go build ./internal/agent/...
go vet ./internal/agent/...
  </verify>
  <done>
types.go exports Task, TaskResult, TaskStatus, C7EvaluationResult
executor.go exports Executor, NewExecutor, CheckClaudeCLI with graceful timeout pattern
  </done>
</task>

<task type="auto">
  <name>Task 2: Create task definitions and workspace isolation</name>
  <files>
    internal/agent/tasks.go
    internal/agent/workspace.go
  </files>
  <action>
Create internal/agent/tasks.go with 4 standardized task definitions per CONTEXT.md:

1. IntentClarityTask - Tests agent's ability to understand code purpose:
   - ID: "intent_clarity"
   - Name: "Intent Clarity"
   - Description: "Measures agent's ability to find and explain code purpose"
   - Prompt: "Find the main entry point function in this project and explain what it does. Include: 1) The function name and file location, 2) What the function accomplishes, 3) Key dependencies or imports it uses. Be specific and reference actual code."
   - ToolsAllowed: "Read,Glob,Grep"
   - TimeoutSeconds: 300

2. ModificationConfidenceTask - Tests agent's ability to make targeted changes:
   - ID: "modification_confidence"
   - Name: "Modification Confidence"
   - Description: "Measures agent's ability to propose safe, scoped changes"
   - Prompt: "Find a function in this project that would benefit from input validation. Propose the specific validation code to add, showing: 1) The function to modify and its location, 2) The exact code changes (diff-style), 3) Why this validation is appropriate. Do not actually modify the file - just propose the change."
   - ToolsAllowed: "Read,Glob,Grep"
   - TimeoutSeconds: 300

3. CrossFileCoherenceTask - Tests agent's multi-file navigation:
   - ID: "cross_file_coherence"
   - Name: "Cross-File Coherence"
   - Description: "Measures agent's ability to trace code across files"
   - Prompt: "Trace the data flow for the primary operation in this project. Start from an entry point (CLI command, API handler, or main function) and follow the data through to where it's processed or stored. Show: 1) The starting point, 2) Each file/function the data passes through, 3) The final destination. Reference actual file paths and function names."
   - ToolsAllowed: "Read,Glob,Grep"
   - TimeoutSeconds: 300

4. SemanticCompletenessTask - Tests agent's context-aware modifications:
   - ID: "semantic_completeness"
   - Name: "Semantic Completeness"
   - Description: "Measures agent's ability to follow existing patterns"
   - Prompt: "Find an area of this codebase that could benefit from improved error handling. Propose error handling that matches existing patterns in the codebase. Show: 1) The code location needing improvement, 2) Examples of existing error handling patterns you found, 3) Your proposed changes that follow those patterns. Do not actually modify files - just propose the change."
   - ToolsAllowed: "Read,Glob,Grep"
   - TimeoutSeconds: 300

Export AllTasks() []Task function that returns all 4 tasks.

Create internal/agent/workspace.go with:
- CreateWorkspace(projectDir string) (workDir string, cleanup func(), err error):
  - Creates temp directory with os.MkdirTemp("", "ars-c7-*")
  - Attempts git worktree add: exec.Command("git", "worktree", "add", worktreeDir, "HEAD", "--detach")
  - If git worktree fails (not a git repo), fall back to read-only mode:
    - Return projectDir as workDir (agent reads original)
    - cleanup is no-op
    - Log warning that modifications won't be isolated
  - On success: cleanup removes worktree via git worktree remove --force + os.RemoveAll

Note: Tasks use Read-only tools only (Read,Glob,Grep) so workspace isolation is primarily for safety. The agent won't actually modify files with these tool permissions.
  </action>
  <verify>
go build ./internal/agent/...
go test ./internal/agent/... -run TestAllTasksDefined -v || echo "Test will be added next"
  </verify>
  <done>
tasks.go exports AllTasks(), IntentClarityTask, ModificationConfidenceTask, CrossFileCoherenceTask, SemanticCompletenessTask
workspace.go exports CreateWorkspace with git worktree or fallback
  </done>
</task>

<task type="auto">
  <name>Task 3: Add executor tests</name>
  <files>
    internal/agent/executor_test.go
  </files>
  <action>
Create internal/agent/executor_test.go with tests:

1. TestCheckClaudeCLI_NotInstalled:
   - This test is tricky since we can't uninstall claude
   - Test the error message format when exec.LookPath fails
   - Use a mock approach: create a helper that takes a lookPath func parameter
   - Or: test that CheckClaudeCLI returns nil when claude is found (skip if not available)

2. TestAllTasksDefined:
   - Verify AllTasks() returns exactly 4 tasks
   - Verify each task has non-empty ID, Name, Prompt
   - Verify all tasks have ToolsAllowed set
   - Verify all tasks have reasonable TimeoutSeconds (> 60, < 600)

3. TestTaskResultStatuses:
   - Verify TaskStatus constants are defined: "completed", "timeout", "error", "cli_not_found"

4. TestCreateWorkspace_NonGitDir:
   - Create temp dir without .git
   - Call CreateWorkspace
   - Verify it returns the original dir (fallback mode)
   - Verify cleanup is callable (no-op)

5. TestCreateWorkspace_WithGitRepo (integration test):
   - Skip if not in a git repo
   - Use the actual ARS repo (the project itself)
   - Call CreateWorkspace with repo root
   - Verify worktree is created
   - Call cleanup
   - Verify worktree is removed

6. TestExecutor_JSONParsing:
   - Test parseJSONOutput function with valid JSON
   - Test parseJSONOutput with malformed JSON (returns error)
   - Test parseJSONOutput with empty response

Note: Actually executing Claude CLI requires the CLI to be installed and API key to be set, which may not be available in CI. Use t.Skip for integration tests that require real CLI.
  </action>
  <verify>
go test ./internal/agent/... -v
  </verify>
  <done>
Tests pass covering task definitions, result types, workspace creation, and JSON parsing
  </done>
</task>

</tasks>

<verification>
All checks pass:
- go build ./internal/agent/...
- go vet ./internal/agent/...
- go test ./internal/agent/... -v
- Package exports: Executor, NewExecutor, CheckClaudeCLI, AllTasks, CreateWorkspace, Task, TaskResult
</verification>

<success_criteria>
1. internal/agent package builds without errors
2. CheckClaudeCLI correctly detects Claude CLI availability
3. Executor implements subprocess invocation with 5-minute timeout and graceful cancellation
4. 4 task definitions exist with appropriate prompts and tool permissions
5. CreateWorkspace creates isolated git worktree or falls back gracefully
6. All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/10-c7-agent-evaluation/10-01-SUMMARY.md`
</output>
