---
phase: 14-html-enhancements
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - internal/output/descriptions.go
  - internal/output/html.go
  - internal/output/templates/report.html
  - internal/output/templates/styles.css
autonomous: true

must_haves:
  truths:
    - "Each metric in HTML report shows a brief 1-2 sentence description below the metric name"
    - "Clicking a metric expands to show detailed explanation with research citations"
    - "Low-scoring metrics (below threshold) start expanded by default"
    - "Expand All / Collapse All buttons toggle all metric sections"
    - "Expandable sections work via CSS-only details/summary (JS only for bulk toggle)"
  artifacts:
    - path: "internal/output/descriptions.go"
      provides: "Metric descriptions data structure"
      contains: "type MetricDescription struct"
    - path: "internal/output/html.go"
      provides: "Updated HTMLSubScore with description fields"
      contains: "BriefDescription"
    - path: "internal/output/templates/report.html"
      provides: "Details/summary elements for each metric"
      contains: "<details"
    - path: "internal/output/templates/styles.css"
      provides: "Styling for expandable sections"
      contains: "details[open]"
  key_links:
    - from: "internal/output/html.go"
      to: "internal/output/descriptions.go"
      via: "metricDescriptions map lookup"
      pattern: "metricDescriptions\\["
    - from: "internal/output/templates/report.html"
      to: "HTMLSubScore struct"
      via: "template field access"
      pattern: "\\.BriefDescription"
---

<objective>
Add expandable, research-backed metric descriptions to HTML reports.

Purpose: Help users understand what each metric measures, why it matters for AI agents, and how to improve - transforming the report from a score card into an educational resource.

Output: Enhanced HTML report where each metric shows a brief description (always visible) and expands to reveal detailed explanation with research citations. Low-scoring metrics start expanded to draw attention to problem areas.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-html-enhancements/14-RESEARCH.md
@.planning/phases/14-html-enhancements/14-CONTEXT.md
@internal/output/html.go
@internal/output/citations.go
@internal/output/templates/report.html
@internal/output/templates/styles.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create metric descriptions data</name>
  <files>internal/output/descriptions.go</files>
  <action>
Create `descriptions.go` with structured metric description data for all metrics.

Define the data structure:
```go
type MetricDescription struct {
    Brief     string       // 1-2 sentences, always visible
    Detailed  template.HTML // Full HTML content for expanded section
    Threshold float64      // Score below which to auto-expand (typically 6.0)
}

var metricDescriptions = map[string]MetricDescription{...}
```

For each metric in `metricDisplayName()` map (approximately 30 metrics), provide:

1. **Brief** (1-2 sentences): Action-oriented, combines what it measures AND why it matters. Include specific thresholds.
   - Example: "Average cyclomatic complexity per function. Keep under 10 for optimal agent comprehension."

2. **Detailed** (HTML string with sections):
   - `<h4>Definition</h4>` - What the metric measures and how it's calculated
   - `<h4>Why It Matters for AI Agents</h4>` - Impact on agent code comprehension and task completion
   - `<h4>Research Evidence</h4>` - Academic citations with specific findings (use existing citations.go references: McCabe 1976, Fowler 1999, Gao 2017, etc.)
   - `<h4>Recommended Thresholds</h4>` - Target values and what they mean
   - `<h4>How to Improve</h4>` - Actionable steps

3. **Threshold**: Score below which the metric auto-expands (typically 6.0, but use judgment per metric type)

Group metrics by category for maintainability:
- C1 Code Health: complexity_avg, func_length_avg, file_size_avg, afferent_coupling_avg, efferent_coupling_avg, duplication_rate
- C2 Semantic: type_annotation_coverage, naming_consistency, magic_number_ratio, type_strictness, null_safety
- C3 Architecture: max_dir_depth, module_fanout_avg, circular_deps, import_complexity_avg, dead_exports
- C4 Documentation: readme_word_count, comment_density, api_doc_coverage, changelog_present, examples_present, contributing_present, diagrams_present
- C5 Temporal: churn_rate, temporal_coupling_pct, author_fragmentation, commit_stability, hotspot_concentration
- C6 Testing: test_to_code_ratio, coverage_percent, test_isolation, assertion_density_avg, test_file_ratio

Use inline parenthetical citation format: `<span class="citation">(McCabe, 1976)</span>`
  </action>
  <verify>
`go build ./internal/output/...` compiles without errors.
`grep -c "Brief:" internal/output/descriptions.go` shows 25+ metrics defined.
  </verify>
  <done>
All metrics have Brief, Detailed, and Threshold defined. Descriptions are research-backed with proper citations.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update HTML generation to include descriptions</name>
  <files>internal/output/html.go</files>
  <action>
Modify `html.go` to incorporate metric descriptions into the HTML output.

1. Update `HTMLSubScore` struct - add three new fields:
```go
type HTMLSubScore struct {
    // ... existing fields ...
    BriefDescription    string        // Always visible, 1-2 sentences
    DetailedDescription template.HTML // Expandable content with sections
    ShouldExpand        bool          // true if score below threshold
}
```

2. Update `buildHTMLSubScores()` function:
   - Look up each metric in `metricDescriptions` map
   - Populate BriefDescription and DetailedDescription from the lookup
   - Compute `ShouldExpand = ss.Score < desc.Threshold` (use 6.0 as default if metric not found)
   - Handle missing descriptions gracefully (empty strings, ShouldExpand=false)

3. Add a helper function for description lookup:
```go
func getMetricDescription(metricName string) MetricDescription {
    if desc, ok := metricDescriptions[metricName]; ok {
        return desc
    }
    return MetricDescription{Threshold: 6.0} // Default fallback
}
```

Do NOT change the existing `metricDisplayName()` function - it remains for display names.
  </action>
  <verify>
`go build ./internal/output/...` compiles without errors.
`go test ./internal/output/...` passes.
  </verify>
  <done>
HTMLSubScore struct has description fields. buildHTMLSubScores populates them from metricDescriptions map. ShouldExpand computed based on score vs threshold.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update HTML template and CSS for expandable sections</name>
  <files>internal/output/templates/report.html, internal/output/templates/styles.css</files>
  <action>
**Update report.html:**

1. Add Expand All / Collapse All buttons above the categories section:
```html
<div class="expand-controls">
    <button onclick="document.querySelectorAll('details.metric-details').forEach(d => d.open = true)">Expand All</button>
    <button onclick="document.querySelectorAll('details.metric-details').forEach(d => d.open = false)">Collapse All</button>
</div>
```

2. Replace the simple metric table row structure with details/summary. Change from:
```html
<tr>
    <td>{{.DisplayName}}</td>
    ...
</tr>
```

To:
```html
<tr>
    <td class="metric-cell">
        <details class="metric-details" {{if .ShouldExpand}}open{{end}}>
            <summary>
                <span class="metric-name">{{.DisplayName}}</span>
                <span class="chevron"></span>
            </summary>
            {{if .BriefDescription}}
            <div class="metric-brief">{{.BriefDescription}}</div>
            {{end}}
            {{if .DetailedDescription}}
            <div class="metric-detailed">{{.DetailedDescription}}</div>
            {{end}}
        </details>
    </td>
    <td>{{.FormattedValue}}</td>
    <td class="score-cell score-{{.ScoreClass}}">{{printf "%.1f" .Score}}</td>
    <td>{{printf "%.0f" .WeightPct}}%</td>
</tr>
```

**Update styles.css:**

Add these CSS rules (place after .metric-table styles):

```css
/* Expand/Collapse controls */
.expand-controls {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 1rem;
}

.expand-controls button {
    padding: 0.375rem 0.75rem;
    font-size: 0.75rem;
    font-weight: 500;
    color: var(--color-text);
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: 0.25rem;
    cursor: pointer;
    transition: background 0.15s;
}

.expand-controls button:hover {
    background: var(--color-border);
}

/* Metric cell with expandable content */
.metric-cell {
    padding: 0 !important;
}

.metric-details {
    margin: 0;
    padding: 0.5rem 0.75rem;
}

.metric-details summary {
    cursor: pointer;
    list-style: none;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.metric-details summary::-webkit-details-marker {
    display: none;
}

.metric-name {
    font-weight: 500;
}

/* Chevron indicator */
.chevron::before {
    content: "\25B6";
    font-size: 0.6rem;
    color: var(--color-muted);
    transition: transform 0.15s;
    display: inline-block;
}

.metric-details[open] .chevron::before {
    transform: rotate(90deg);
}

/* Brief description (always visible when expanded) */
.metric-brief {
    font-size: 0.8rem;
    color: var(--color-muted);
    margin-top: 0.5rem;
    font-style: italic;
    padding-left: 1rem;
}

/* Detailed content (only visible when expanded) */
.metric-detailed {
    margin-top: 0.75rem;
    padding: 0.75rem;
    background: var(--color-bg);
    border-left: 3px solid var(--color-border);
    border-radius: 0 0.25rem 0.25rem 0;
    font-size: 0.8rem;
    line-height: 1.6;
    margin-left: 1rem;
}

.metric-detailed h4 {
    font-size: 0.8rem;
    font-weight: 600;
    margin: 0.75rem 0 0.25rem 0;
    color: var(--color-text);
}

.metric-detailed h4:first-child {
    margin-top: 0;
}

.metric-detailed p {
    margin: 0.25rem 0;
}

.metric-detailed ul, .metric-detailed ol {
    margin: 0.25rem 0 0.25rem 1.25rem;
}

.metric-detailed li {
    margin: 0.125rem 0;
}

/* Citation styling */
.citation {
    color: var(--color-muted);
    font-style: normal;
}
```

Ensure Safari compatibility with `::-webkit-details-marker` selector.
  </action>
  <verify>
`go build ./internal/output/...` compiles (template parses).
`go run . scan . --output-html > /tmp/test.html && open /tmp/test.html` - visually verify:
- Metrics show chevron and are clickable
- Clicking expands to show brief + detailed content
- Low-scoring metrics are pre-expanded
- Expand All / Collapse All buttons work
  </verify>
  <done>
HTML template uses details/summary for each metric. CSS styles expandable sections with chevron indicators. Expand All / Collapse All buttons present and functional.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `go test ./internal/output/...` - all tests pass
2. `go run . scan . --output-html > /tmp/report.html` - generates HTML without errors
3. Open `/tmp/report.html` in browser and verify:
   - Each metric has a chevron that expands/collapses
   - Brief description appears when expanded
   - Detailed section shows Definition, Why It Matters, Research Evidence, Thresholds, How to Improve
   - Low-scoring metrics start expanded
   - Expand All / Collapse All buttons toggle all sections
   - Works in Safari (webkit marker fix applied)
</verification>

<success_criteria>
- HTML-01: Each metric has brief description visible when expanded
- HTML-02: Each metric has expandable detailed description with research citations
- HTML-03: Expandable sections use CSS-only details/summary (JS only for Expand All)
- HTML-04: Metrics scoring below threshold start expanded by default
</success_criteria>

<output>
After completion, create `.planning/phases/14-html-enhancements/14-01-SUMMARY.md`
</output>
