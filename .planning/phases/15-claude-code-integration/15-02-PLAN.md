---
phase: 15-claude-code-integration
plan: 02
type: execute
wave: 2
depends_on: ["15-01"]
files_modified:
  - cmd/scan.go
  - internal/pipeline/pipeline.go
  - internal/agent/scorer.go
  - internal/analyzer/c7_agent.go
  - go.mod
  - go.sum
autonomous: true

must_haves:
  truths:
    - "LLM analysis auto-enables when CLI is available"
    - "--no-llm flag disables LLM features"
    - "No ANTHROPIC_API_KEY required for any feature"
    - "C7 scoring uses CLI-based evaluator (agent.Evaluator) instead of SDK client (llm.Client)"
    - "Anthropic SDK removed from dependencies"
  artifacts:
    - path: "cmd/scan.go"
      provides: "Updated CLI flags (--no-llm, removed --enable-c4-llm)"
      contains: "noLLM"
    - path: "internal/pipeline/pipeline.go"
      provides: "Auto-detection of CLI and LLM feature enablement"
      contains: "agent.GetCLIStatus"
    - path: "internal/agent/scorer.go"
      provides: "Scorer using CLI evaluator instead of SDK"
      contains: "agent.Evaluator"
    - path: "go.mod"
      provides: "Dependencies without Anthropic SDK"
  key_links:
    - from: "internal/pipeline/pipeline.go"
      to: "internal/agent/cli.go"
      via: "agent.GetCLIStatus()"
      pattern: "agent\\.GetCLIStatus"
    - from: "internal/agent/scorer.go"
      to: "internal/agent/evaluator.go"
      via: "evaluator.EvaluateWithRetry()"
      pattern: "evaluator\\.EvaluateWithRetry"
---

<objective>
Complete Claude CLI migration by removing Anthropic SDK and updating pipeline for auto-detection.

Purpose: Eliminate SDK dependency, simplify user experience with auto-enabled LLM features.
Output: Working ARS with all LLM features using Claude CLI, no SDK, no API key required.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-claude-code-integration/15-CONTEXT.md
@.planning/phases/15-claude-code-integration/15-RESEARCH.md
@.planning/phases/15-claude-code-integration/15-01-SUMMARY.md

# Current implementation
@cmd/scan.go
@internal/pipeline/pipeline.go
@internal/agent/scorer.go
@internal/analyzer/c7_agent.go
@go.mod
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update pipeline for CLI auto-detection</name>
  <files>internal/pipeline/pipeline.go</files>
  <action>
Update `internal/pipeline/pipeline.go` for CLI auto-detection:

1. Remove `llmClient *llm.Client` field from Pipeline struct
   - Replace with `evaluator *agent.Evaluator`
   - Add `cliStatus agent.CLIStatus` field

2. Update `New()` function:
   - At initialization, call `cliStatus := agent.GetCLIStatus()`
   - Store in `p.cliStatus`
   - If CLI available, create evaluator: `p.evaluator = agent.NewEvaluator(60 * time.Second)`
   - Configure C4 analyzer: `c4.SetEvaluator(p.evaluator)` if evaluator != nil

3. Remove `SetLLMClient(client *llm.Client)` method entirely

4. Update `SetC7Enabled(client *llm.Client)` to `SetC7Enabled()`:
   - Pass `p.evaluator` to C7 analyzer instead of llm.Client

5. Add `DisableLLM()` method:
   - Set `p.evaluator = nil`
   - Disable LLM on C4 analyzer: find C4 in analyzers, call `c4.SetEvaluator(nil)`
   - This is called when `--no-llm` flag is set

6. Add `GetCLIStatus() agent.CLIStatus` method for external access

7. Update imports:
   - Remove `"github.com/ingo/agent-readyness/internal/llm"`
   - Ensure `"github.com/ingo/agent-readyness/internal/agent"` is imported

8. Remove `llm.EstimateCost` and `llm.EstimateC7Cost` references (cost estimation removed - CLI handles costs)
  </action>
  <verify>
Run: `go build ./internal/pipeline/...` - should compile (may fail until scan.go updated)
  </verify>
  <done>Pipeline auto-detects CLI and creates evaluator, no llm.Client dependency</done>
</task>

<task type="auto">
  <name>Task 2: Update scan command - flag changes</name>
  <files>cmd/scan.go</files>
  <action>
Update flag definitions and registration in `cmd/scan.go`:

1. Remove flag variables:
   - Delete `enableC4LLM bool`

2. Add new flag variable:
   - `noLLM bool` - disable LLM features even when CLI available

3. Update flag registration in `init()`:
   - Remove: `scanCmd.Flags().BoolVar(&enableC4LLM, "enable-c4-llm", ...)`
   - Add: `scanCmd.Flags().BoolVar(&noLLM, "no-llm", false, "disable LLM features even when Claude CLI is available")`

4. Keep `enableC7 bool` flag unchanged (C7 requires explicit opt-in due to cost/time)
  </action>
  <verify>
Run: `go build ./cmd/...` - may have errors until Task 3/4 complete, that's OK
  </verify>
  <done>Flag definitions updated: --no-llm added, --enable-c4-llm removed</done>
</task>

<task type="auto">
  <name>Task 3: Update scan command - C4 flow cleanup</name>
  <files>cmd/scan.go</files>
  <action>
Update C4/LLM handling in RunE function of `cmd/scan.go`:

1. Remove entire `if enableC4LLM { ... }` block:
   - Remove ANTHROPIC_API_KEY check
   - Remove cost estimate display
   - Remove user confirmation prompt
   - Remove llmClient creation

2. After pipeline creation, add CLI status display:
   ```go
   cliStatus := p.GetCLIStatus()
   if cliStatus.Available {
       if noLLM {
           p.DisableLLM()
           fmt.Fprintf(cmd.OutOrStdout(), "LLM features disabled (--no-llm flag)\n")
       } else {
           fmt.Fprintf(cmd.OutOrStdout(), "Claude CLI detected (%s) - LLM features enabled\n", cliStatus.Version)
       }
   } else {
       fmt.Fprintf(cmd.OutOrStdout(), "Claude CLI not found - LLM features disabled\n")
       if verbose {
           fmt.Fprintf(cmd.OutOrStdout(), "  %s\n", cliStatus.InstallHint)
       }
   }
   ```

3. Remove `bufio` import if only used for LLM confirmation
  </action>
  <verify>
Run: `go build ./cmd/...` - may have errors until Task 4 complete
  </verify>
  <done>C4 LLM flow simplified: no API key check, no cost estimate, no confirmation prompt</done>
</task>

<task type="auto">
  <name>Task 4: Update scan command - C7 flow cleanup</name>
  <files>cmd/scan.go</files>
  <action>
Update C7 handling in RunE function of `cmd/scan.go`:

1. Remove ANTHROPIC_API_KEY requirement for C7
2. Keep CLI availability check (`agent.CheckClaudeCLI()`)
3. Remove cost estimate display for C7
4. Remove user confirmation prompts for C7 (CLI handles auth/billing)
5. Simplify to: if enableC7, check CLI available, call `p.SetC7Enabled()`

6. Remove remaining llm imports:
   - Remove `"github.com/ingo/agent-readyness/internal/llm"`
  </action>
  <verify>
Run: `go build ./cmd/...` - should compile
Run: `go run . scan --help` - should show --no-llm flag, NOT show --enable-c4-llm
  </verify>
  <done>Scan command C7 flow simplified: no API key requirement, no cost estimate, CLI-only check</done>
</task>

<task type="auto">
  <name>Task 5: Migrate C7 scorer and remove SDK dependency</name>
  <files>internal/agent/scorer.go, internal/analyzer/c7_agent.go, go.mod, go.sum</files>
  <action>
**Part A: Update `internal/agent/scorer.go`**

1. Change from llm.Client to agent.Evaluator:
   - Replace `llmClient *llm.Client` field with `evaluator *Evaluator`
   - Update `NewScorer(client *llm.Client)` to `NewScorer(evaluator *Evaluator)`

2. Update Score method:
   - Replace `s.llmClient.EvaluateContent(ctx, rubric, content)` with:
     `s.evaluator.EvaluateWithRetry(ctx, rubric, content)`
   - **Field mapping note:** The old llm.Evaluation struct used `Reasoning string` while
     the new agent.EvaluationResult uses `Reason string`. Update any code that accessed
     `.Reasoning` to use `.Reason` instead. The Score field name is the same in both.

3. Remove import of `internal/llm`

**Part B: Update `internal/analyzer/c7_agent.go`**

1. Remove `llmClient *llm.Client` field from C7Analyzer struct
   - Replace with `evaluator *agent.Evaluator`

2. Update `Enable(client *llm.Client)` to `Enable(evaluator *agent.Evaluator)`:
   - Set `a.evaluator = evaluator`
   - Set `a.enabled = true`

3. Update Analyze method:
   - Replace `scorer := agent.NewScorer(a.llmClient)` with:
     `scorer := agent.NewScorer(a.evaluator)`

4. Remove import of `internal/llm`

**Part C: Delete `internal/llm/` package**

Delete entire directory:
- `internal/llm/client.go`
- `internal/llm/client_test.go`
- `internal/llm/cost.go`
- `internal/llm/prompts.go`

**Part D: Update `go.mod`**

Run: `go mod tidy`

This should automatically remove:
- `github.com/anthropics/anthropic-sdk-go`
- Any transitive dependencies only used by SDK (tidywall/gjson, etc.)

Verify SDK is gone: `grep anthropic go.mod` should return nothing
  </action>
  <verify>
Run: `go build ./...` - entire project compiles
Run: `grep -r "internal/llm" --include="*.go" .` - should return nothing (no llm imports)
Run: `grep anthropic go.mod` - should return nothing
Run: `go test ./internal/agent/...` - scorer tests pass
Run: `go test ./internal/analyzer/...` - C7 tests pass
  </verify>
  <done>SDK removed, scorer uses CLI evaluator with Reason field (not Reasoning), C7 analyzer uses CLI evaluator, go.mod clean</done>
</task>

</tasks>

<verification>
After all tasks:
1. `go build ./...` compiles without errors
2. `go test ./...` all tests pass
3. `grep anthropic go.mod` returns nothing (SDK removed)
4. `grep -r "internal/llm" --include="*.go" .` returns nothing (llm package gone)
5. `go run . scan --help` shows --no-llm, no --enable-c4-llm
6. `go run . scan .` auto-detects CLI and shows status message
7. `ANTHROPIC_API_KEY="" go run . scan .` works (no API key required)
</verification>

<success_criteria>
- Pipeline auto-detects CLI availability at startup
- LLM features enabled automatically when CLI available
- --no-llm flag disables LLM features
- --enable-c4-llm flag removed (unknown flag error if used)
- No ANTHROPIC_API_KEY required for any operation
- C7 scorer uses CLI-based evaluator
- internal/llm/ package deleted
- Anthropic SDK removed from go.mod
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/15-claude-code-integration/15-02-SUMMARY.md`
</output>
