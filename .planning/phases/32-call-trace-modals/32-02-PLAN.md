---
phase: 32-call-trace-modals
plan: 02
type: execute
wave: 2
depends_on: ["32-01"]
files_modified:
  - internal/output/trace.go
  - internal/output/html.go
  - internal/output/templates/styles.css
autonomous: true

must_haves:
  truths:
    - "Every C1-C6 metric with trace data shows a breakpoint table with the current band highlighted"
    - "Every C1-C6 metric with evidence shows top-5 worst offenders in the trace modal"
    - "Breakpoint table renders scoring ranges with visual emphasis on where the value landed"
    - "JSON and code content in trace modals has subtle syntax highlighting (2-3 colors)"
  artifacts:
    - path: "internal/output/trace.go"
      provides: "renderBreakpointTrace and syntax highlighting helpers"
    - path: "internal/output/html.go"
      provides: "C1-C6 trace data wiring in buildHTMLSubScores"
  key_links:
    - from: "internal/output/html.go"
      to: "internal/output/trace.go"
      via: "buildHTMLSubScores calls renderBreakpointTrace for C1-C6 metrics"
      pattern: "renderBreakpointTrace"
    - from: "internal/output/trace.go"
      to: "internal/scoring/config.go"
      via: "Reads breakpoint definitions to build scoring table"
      pattern: "scoring\\.Breakpoint"
---

<objective>
Add C1-C6 scoring explanation traces showing breakpoint tables (with current band highlighted) and top-5 worst offender evidence, plus subtle syntax highlighting for code/JSON content in all trace modals.

Purpose: C1-C6 metrics use piecewise linear interpolation. Users need to see the scoring scale (breakpoint ranges), where their value falls, and which specific files/functions are the worst offenders.

Output: All metrics (C1-C7) have functional View Trace modals. Syntax highlighting applied to code blocks.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/32-call-trace-modals/32-RESEARCH.md
@.planning/phases/32-call-trace-modals/32-01-SUMMARY.md
@internal/output/trace.go
@internal/output/html.go
@internal/output/templates/styles.css
@internal/scoring/config.go
@pkg/types/types.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Render C1-C6 breakpoint tables and evidence in trace modals</name>
  <files>
    internal/output/trace.go
    internal/output/html.go
  </files>
  <action>
  **Add to `trace.go`:**

  1. `renderBreakpointTrace(metricName string, rawValue float64, score float64, breakpoints []scoring.Breakpoint, evidence []types.EvidenceItem) string` -- renders the full C1-C6 trace modal content:

     **Breakpoint table section:**
     - `<div class="trace-section"><h4>Scoring Scale</h4>`
     - `<table class="trace-breakpoint-table">` with columns: Range, Score
     - Each row shows a breakpoint range. For breakpoint at index i:
       - If i==0: range is "≤ {value}"
       - If i==last: range is "≥ {value}"
       - Otherwise: range is "{prev_value} - {value}"
     - The row where the current rawValue falls gets `class="trace-current-band"` (highlighted)
     - Current band detection: rawValue is between breakpoints[i-1].Value and breakpoints[i].Value (handle edge cases for first/last)
     - After the table: `<p class="trace-summary">Current value: <strong>{formatted_value}</strong> -> Score: <strong>{score}</strong></p>`
     - Use `formatMetricValue()` from html.go to format the raw value consistently.

     **Evidence section (only if evidence is non-empty):**
     - `<div class="trace-section"><h4>Top Offenders</h4>`
     - `<table class="trace-evidence-table">` with columns: File, Line, Value, Description
     - Each evidence item becomes a row. Use `template.HTMLEscapeString()` on all string values.
     - File paths shown in full (no abbreviation per CONTEXT.md decision).

  2. Helper `findCurrentBand(rawValue float64, breakpoints []scoring.Breakpoint) int` -- returns the index of the breakpoint that defines the current scoring band. Returns -1 if breakpoints empty.

  **Wire into `html.go` buildHTMLSubScores:**
  When TraceData is available and the category is NOT "C7", look up the metric's breakpoints from `TraceData.ScoringConfig.Categories[catName].Metrics` (match by metric name). Look up evidence from the sub-score's Evidence field. Call `renderBreakpointTrace()` and set TraceHTML + HasTrace.

  Note: `buildHTMLSubScores` needs to receive the category name and TraceData. Update its signature to accept these. The category name comes from buildHTMLCategories which already has it.

  HasTrace should be true when: (a) breakpoints exist for the metric, OR (b) evidence is non-empty, OR (c) it's a C7 metric with debug samples. A metric with no breakpoints AND no evidence should have HasTrace=false (e.g., boolean metrics like changelog_present may have simple traces or none).
  </action>
  <verify>
  `go build ./...` compiles. `go test ./...` passes. Generate HTML: `go run . scan internal/analyzer --output-html /tmp/trace-test.html`. Open in browser. Click "View Trace" on any C1-C6 metric. Modal should show a breakpoint table with one row highlighted, and a list of top offenders below. Verify breakpoint values match `internal/scoring/config.go` definitions.
  </verify>
  <done>
  All C1-C6 metrics show breakpoint scoring tables with current band highlighted and evidence tables with worst offenders. View Trace buttons appear for all metrics with trace data.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add syntax highlighting CSS and trace table styling</name>
  <files>
    internal/output/templates/styles.css
    internal/output/templates/report.html
  </files>
  <action>
  **CSS additions to styles.css:**

  Trace sections:
  - `.trace-section` -- margin-bottom 1.5rem
  - `.trace-section h4` -- font-size 0.875rem, font-weight 600, margin-bottom 0.5rem, color var(--color-text)

  Breakpoint table:
  - `.trace-breakpoint-table` -- width 100%, border-collapse collapse, font-size 0.8125rem, margin-bottom 0.75rem
  - `.trace-breakpoint-table th` -- text-align left, padding 0.375rem 0.75rem, border-bottom 2px solid var(--color-border), font-weight 600, color var(--color-muted)
  - `.trace-breakpoint-table td` -- padding 0.375rem 0.75rem, border-bottom 1px solid var(--color-border)
  - `.trace-current-band` -- background-color #fef3c7 (light amber), font-weight 600
  - `.trace-current-band td` -- border-bottom-color #f59e0b (amber accent)
  - `.trace-summary` -- font-size 0.8125rem, color var(--color-muted), margin-top 0.5rem

  Evidence table:
  - `.trace-evidence-table` -- width 100%, border-collapse collapse, font-size 0.75rem
  - `.trace-evidence-table th` -- same as breakpoint table th
  - `.trace-evidence-table td` -- padding 0.375rem 0.75rem, border-bottom 1px solid var(--color-border), font-family monospace (for file paths)
  - `.trace-evidence-table td:first-child` -- max-width 300px, overflow hidden, text-overflow ellipsis, white-space nowrap (file paths may be long, show full path on hover via title attr)

  Syntax highlighting (subtle, 2-3 colors as per CONTEXT.md):
  - `.trace-json-key` -- color #0550ae (blue for JSON keys)
  - `.trace-json-string` -- color #0a3069 (dark blue for string values)
  - `.trace-json-number` -- color #953800 (orange for numbers)

  **Add simple JSON syntax highlighting JS to report.html:**
  After the existing modal script block, add a small function that post-processes code blocks inside the modal after openModal() is called. Modify `openModal()` to call `highlightTraceCode()` after setting innerHTML:
  ```javascript
  function highlightTraceCode() {
      arsModalBody.querySelectorAll('pre code').forEach(function(block) {
          // Simple regex-based JSON key/value highlighting
          var html = block.innerHTML;
          // Highlight JSON keys: "key":
          html = html.replace(/(&quot;|")([^"]+?)(&quot;|")\s*:/g, '<span class="trace-json-key">"$2"</span>:');
          // Highlight JSON string values: : "value"
          html = html.replace(/:\s*(&quot;|")([^"]*?)(&quot;|")/g, ': <span class="trace-json-string">"$2"</span>');
          // Highlight numbers
          html = html.replace(/:\s*(\d+\.?\d*)/g, ': <span class="trace-json-number">$1</span>');
          block.innerHTML = html;
      });
  }
  ```
  Call `highlightTraceCode()` at the end of `openModal()`.

  Note: The highlighting is intentionally simple and imperfect. It works well enough for JSON-like content (C7 prompts/responses often contain JSON). For plain text, the regexes will mostly not match, which is fine -- no highlighting is applied.
  </action>
  <verify>
  `go build ./...` compiles. Generate HTML: `go run . scan internal/analyzer --output-html /tmp/trace-test.html`. Open in browser:
  1. C1-C6 trace modals: breakpoint table has one highlighted row (amber background), evidence table has monospace file paths.
  2. C7 trace modals: prompt/response code blocks have subtle color on JSON-like content.
  3. Copy buttons work on code blocks.
  4. All modal styling is clean and readable.
  </verify>
  <done>
  Trace modals have polished styling: breakpoint tables with highlighted current band, evidence tables with monospace file paths, and subtle syntax highlighting for JSON content in code blocks.
  </done>
</task>

</tasks>

<verification>
1. `go build ./...` -- no compilation errors
2. `go test ./...` -- all tests pass
3. `go run . scan internal/analyzer --output-html /tmp/trace-test.html` -- generates valid HTML
4. Every C1-C6 metric with breakpoints has a View Trace button
5. Breakpoint table highlights the correct current band
6. Evidence table shows file paths, line numbers, values, descriptions
7. JSON content in C7 modals has subtle color highlighting
</verification>

<success_criteria>
- C1-C6 trace modals show breakpoint scoring table with current band highlighted in amber
- C1-C6 trace modals show top-5 worst offenders table below breakpoints
- Syntax highlighting uses 2-3 subtle colors for JSON keys/values/numbers
- All trace modals render cleanly in the existing modal infrastructure
- Existing tests and HTML report generation still work
</success_criteria>

<output>
After completion, create `.planning/phases/32-call-trace-modals/32-02-SUMMARY.md`
</output>
