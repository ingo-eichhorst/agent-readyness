---
phase: 32-call-trace-modals
plan: 03
type: execute
wave: 3
depends_on: ["32-02"]
files_modified:
  - internal/output/templates/report.html
  - internal/output/templates/styles.css
  - internal/output/html.go
  - internal/pipeline/pipeline.go
autonomous: true

must_haves:
  truths:
    - "Without JavaScript, trace content is visible in <details> fallback elements"
    - "With JavaScript, <details> fallbacks are hidden and modal buttons are visible"
    - "HTML report generation prints file size to terminal as informational output"
    - "View Trace buttons hidden by noscript style (existing pattern from Phase 31)"
  artifacts:
    - path: "internal/output/templates/report.html"
      provides: "<details> fallback for trace content, js-enabled class toggling"
    - path: "internal/output/templates/styles.css"
      provides: "Styles for noscript fallback visibility"
  key_links:
    - from: "internal/output/templates/report.html"
      to: "internal/output/html.go"
      via: "TraceHTML rendered in both <template> (modal) and <details> (fallback)"
      pattern: "trace-fallback"
---

<objective>
Add progressive enhancement so trace content is accessible without JavaScript (via native `<details>` elements), and add informational file size reporting when generating HTML reports.

Purpose: TR-08 requires `<details>` fallback without JS. Users opening HTML reports in restricted environments (email clients, print view) should still see trace data. File size reporting helps users monitor report bloat from embedded C7 data.

Output: Complete Phase 32 -- all trace modals work with and without JS, file size reported at generation time.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/32-call-trace-modals/32-RESEARCH.md
@.planning/phases/32-call-trace-modals/32-02-SUMMARY.md
@internal/output/templates/report.html
@internal/output/templates/styles.css
@internal/output/html.go
@internal/pipeline/pipeline.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add progressive enhancement fallback and file size reporting</name>
  <files>
    internal/output/templates/report.html
    internal/output/templates/styles.css
    internal/output/html.go
    internal/pipeline/pipeline.go
  </files>
  <action>
  **Progressive enhancement (report.html + styles.css):**

  1. Add a `<script>document.body.classList.add('js-enabled');</script>` at the very start of `<body>` (before any content). This class indicates JS is available.

  2. For each metric that has trace data, add a `<details class="trace-fallback">` element INSIDE the metric-details-row (after the existing description content). This renders the same TraceHTML content directly in the page:
     ```html
     {{if .HasTrace}}
     <details class="trace-fallback">
       <summary>Scoring Trace</summary>
       <div class="trace-fallback-content">{{.TraceHTML}}</div>
     </details>
     {{end}}
     ```

  3. CSS rules for progressive enhancement:
     - `.js-enabled .trace-fallback` -- `display: none` (hide fallback when JS is available, since modals work)
     - `.trace-fallback` -- margin-top 0.75rem (when visible without JS, has spacing)
     - `.trace-fallback summary` -- cursor pointer, font-weight 600, font-size 0.8125rem, color var(--color-muted)
     - `.trace-fallback-content` -- padding 0.75rem 0

  4. The existing `<noscript>` style in `<head>` already hides `.ars-modal-trigger` buttons. This means:
     - With JS: modal buttons visible, `<details>` fallback hidden (via `.js-enabled`)
     - Without JS: modal buttons hidden (via `<noscript>`), `<details>` fallback visible

  5. Remove the copy buttons from the `<details>` fallback content by NOT rendering copy buttons in the fallback version. Since TraceHTML is the same for both modal and fallback, and copy buttons use `navigator.clipboard` (JS-only), leave them in -- they simply won't work without JS but cause no harm. The `<details>` element itself provides access to the content which is the requirement.

  **File size reporting (pipeline.go):**

  After `gen.GenerateReport(f, ...)` succeeds in `generateHTMLReport()`, stat the file and print the size:
  ```go
  fi, err := f.Stat()
  if err == nil {
      sizeKB := fi.Size() / 1024
      fmt.Fprintf(p.writer, "HTML report: %s (%d KB)\n", p.htmlOutput, sizeKB)
  }
  ```
  Note: `f` is an `*os.File` so `f.Stat()` works. Print after closing (move the close before the stat, or use os.Stat on the path). The message is informational -- no warning threshold per CONTEXT.md decision (size budget removed).

  Actually, since `f` has `defer f.Close()`, use `os.Stat(p.htmlOutput)` after the GenerateReport call instead to get the size after writing is complete. Or flush+stat before close. Simplest: after GenerateReport returns, call `f.Sync()` then `fi, _ := f.Stat()`.
  </action>
  <verify>
  1. `go build ./...` compiles
  2. `go test ./...` passes
  3. Generate HTML: `go run . scan internal/analyzer --output-html /tmp/trace-test.html`
     - Terminal output includes file size line like "HTML report: /tmp/trace-test.html (XX KB)"
  4. Open HTML in browser:
     - View Trace buttons visible, clicking opens modal
     - `<details class="trace-fallback">` elements exist in source but are hidden (inspect DOM)
  5. Disable JavaScript in browser (or view source):
     - View Trace buttons are hidden
     - `<details>` elements with "Scoring Trace" summary are visible and expandable
     - Trace content (breakpoint tables, evidence) is accessible
  </verify>
  <done>
  Trace content accessible with and without JavaScript. File size reported when HTML generated. Phase 32 complete.
  </done>
</task>

</tasks>

<verification>
1. `go build ./...` -- no compilation errors
2. `go test ./...` -- all tests pass
3. HTML report generates with file size printed to terminal
4. With JS enabled: modal buttons work, fallback hidden
5. Without JS: fallback `<details>` visible and expandable, modal buttons hidden
6. All Phase 32 success criteria met:
   - Every metric row has View Trace button (when trace data exists)
   - C7 trace shows prompts, responses, score breakdown with indicators
   - C1-C6 trace shows breakpoints, current value, top-5 offenders
   - Syntax highlighting uses subtle colors
   - Progressive enhancement works both ways
</verification>

<success_criteria>
- `<details>` fallback visible without JS, hidden with JS
- View Trace buttons hidden without JS (existing noscript pattern)
- File size printed to terminal when generating HTML report
- Full Phase 32 functionality complete and tested
</success_criteria>

<output>
After completion, create `.planning/phases/32-call-trace-modals/32-03-SUMMARY.md`
</output>
