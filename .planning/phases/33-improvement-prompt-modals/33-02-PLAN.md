---
phase: 33-improvement-prompt-modals
plan: 02
type: execute
wave: 2
depends_on: ["33-01"]
files_modified:
  - internal/output/html.go
  - internal/pipeline/pipeline.go
  - internal/output/templates/report.html
  - internal/output/templates/styles.css
autonomous: true

must_haves:
  truths:
    - "Every metric row in the HTML report has an Improve button that opens a modal with a prompt"
    - "The prompt contains the metric's current score, target score, and evidence file paths"
    - "Clicking Copy places the prompt text on the clipboard with Copied! confirmation"
    - "On file:// protocol, copy still works via execCommand fallback or shows selectable pre block"
    - "All 7 categories (C1-C7) have prompts rendered for metrics scoring below 9.0"
    - "No-JS fallback shows prompt in details element"
  artifacts:
    - path: "internal/output/html.go"
      provides: "HTMLSubScore.PromptHTML and HasPrompt fields, prompt wiring in buildHTMLSubScores"
      contains: "PromptHTML"
    - path: "internal/output/templates/report.html"
      provides: "Improve button, prompt template elements, copyPromptText JS, details fallback"
      contains: "copyPromptText"
    - path: "internal/output/templates/styles.css"
      provides: "prompt-copy-container styling"
      contains: "prompt-copy-container"
  key_links:
    - from: "internal/output/html.go"
      to: "internal/output/prompt.go"
      via: "renderImprovementPrompt() call in buildHTMLSubScores"
      pattern: "renderImprovementPrompt"
    - from: "internal/output/html.go"
      to: "internal/pipeline/pipeline.go"
      via: "TraceData.Languages field threaded from pipeline"
      pattern: "TraceData"
    - from: "internal/output/templates/report.html"
      to: "internal/output/html.go"
      via: "HTMLSubScore.HasPrompt and PromptHTML template fields"
      pattern: "HasPrompt"
---

<objective>
Wire prompt rendering into the HTML report with Improve buttons, clipboard copy with fallback chain, and progressive enhancement.

Purpose: This connects the prompt engine (Plan 01) to the user-facing HTML report, adding "Improve" buttons next to "View Trace" buttons for every metric, with copy-to-clipboard functionality that works on both HTTPS and file:// protocols.

Output: Modified `html.go` (new fields + wiring), `pipeline.go` (language threading), `report.html` (buttons + JS), `styles.css` (prompt styling).
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/33-improvement-prompt-modals/33-RESEARCH.md
@.planning/phases/33-improvement-prompt-modals/33-01-SUMMARY.md
@internal/output/prompt.go
@internal/output/html.go
@internal/output/trace.go
@internal/output/templates/report.html
@internal/output/templates/styles.css
@internal/pipeline/pipeline.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add prompt fields to HTMLSubScore and wire rendering in html.go + pipeline.go</name>
  <files>internal/output/html.go, internal/pipeline/pipeline.go</files>
  <action>
**In `internal/output/html.go`:**

1. Add two fields to `HTMLSubScore` struct:
   ```go
   PromptHTML  template.HTML  // Pre-rendered improvement prompt modal content
   HasPrompt   bool           // Whether prompt data is available
   ```

2. Add a `Languages []string` field to `TraceData` struct:
   ```go
   type TraceData struct {
       ScoringConfig   *scoring.ScoringConfig
       AnalysisResults []*types.AnalysisResult
       Languages       []string  // Detected project languages for build/test commands
   }
   ```

3. In `buildHTMLSubScores()`, after the existing trace population block (the `if categoryName != "C7" && trace != nil` block that ends around line 272), add prompt population:

   ```go
   // Populate improvement prompt (for metrics scoring below 9.0 and available)
   if ss.Available && ss.Score < 9.0 && trace != nil {
       // Determine language for build commands
       lang := ""
       if len(trace.Languages) > 0 {
           lang = string(trace.Languages[0])
       }

       // Get breakpoints for target calculation
       var breakpoints []scoring.Breakpoint
       if trace.ScoringConfig != nil {
           catCfg := trace.ScoringConfig.Category(categoryName)
           for _, mt := range catCfg.Metrics {
               if mt.Name == ss.MetricName {
                   breakpoints = mt.Breakpoints
                   break
               }
           }
       }

       // Calculate target
       targetValue, targetScore := nextTarget(ss.Score, breakpoints)

       promptHTML := renderImprovementPrompt(PromptParams{
           CategoryName:    categoryName,
           CategoryDisplay: categoryDisplayName(categoryName),
           CategoryImpact:  categoryImpact(categoryName),
           MetricName:      ss.MetricName,
           MetricDisplay:   metricDisplayName(ss.MetricName),
           RawValue:        ss.RawValue,
           FormattedValue:  formatMetricValue(ss.MetricName, ss.RawValue, ss.Available),
           Score:           ss.Score,
           TargetScore:     targetScore,
           TargetValue:     targetValue,
           HasBreakpoints:  len(breakpoints) > 0,
           Evidence:        ss.Evidence,
           Language:        lang,
       })
       if promptHTML != "" {
           hss.PromptHTML = template.HTML(promptHTML)
           hss.HasPrompt = true
       }
   }
   ```

   Note: The `trace` variable is already passed to `buildHTMLSubScores()`. The breakpoint lookup code can be shared with the existing C1-C6 trace block above -- consider extracting the breakpoint lookup into a local variable used by both blocks.

4. The `buildHTMLSubScores` function signature already receives `trace *TraceData`. The Languages field will be populated by the pipeline.

**In `internal/pipeline/pipeline.go`:**

5. Thread detected languages into TraceData. Find the block around line 346 where `traceData` is constructed:
   ```go
   traceData := &output.TraceData{
       ScoringConfig:   p.scorer.Config,
       AnalysisResults: p.results,
   }
   ```

   The `langs` variable (from `discovery.DetectProjectLanguages(dir)` at line 174) is in function scope of `Run()` but the HTML generation happens in `generateHTMLReport()` which is a separate method. You need to:
   - Add a `languages []types.Language` field to the `Pipeline` struct, OR
   - Store `langs` on the pipeline during `Run()` so `generateHTMLReport()` can access it.

   Simplest approach: Add `langs []types.Language` field to Pipeline struct. Set it in Run() after DetectProjectLanguages(). In generateHTMLReport(), convert to []string and pass to TraceData:
   ```go
   langStrings := make([]string, len(p.langs))
   for i, l := range p.langs {
       langStrings[i] = string(l)
   }
   traceData := &output.TraceData{
       ScoringConfig:   p.scorer.Config,
       AnalysisResults: p.results,
       Languages:       langStrings,
   }
   ```
  </action>
  <verify>
  Run `go build ./...` -- must compile without errors.
  Run `go test ./internal/output/... ./internal/pipeline/...` -- all existing tests pass.
  </verify>
  <done>
  HTMLSubScore has PromptHTML/HasPrompt fields. buildHTMLSubScores populates prompts for metrics scoring below 9.0. Pipeline threads detected languages to TraceData. All existing tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Improve button, clipboard JS, and prompt styles to HTML template</name>
  <files>internal/output/templates/report.html, internal/output/templates/styles.css</files>
  <action>
**In `internal/output/templates/report.html`:**

1. **Add Improve button** next to the existing View Trace button in the metric row (line 89 area). The trace-cell currently has:
   ```html
   <td class="trace-cell">{{if .HasTrace}}<button class="ars-modal-trigger" ...>View Trace</button>{{end}}</td>
   ```

   Change to include both buttons:
   ```html
   <td class="trace-cell">
     {{if .HasTrace}}<button class="ars-modal-trigger" onclick="openModal('{{.DisplayName}} Trace', document.getElementById('trace-{{.Key}}').innerHTML)">View Trace</button>{{end}}
     {{if .HasPrompt}}<button class="ars-modal-trigger prompt-btn" onclick="openModal('Improve {{.DisplayName}}', document.getElementById('prompt-{{.Key}}').innerHTML)">Improve</button>{{end}}
   </td>
   ```

2. **Add prompt template storage** alongside the existing trace templates (line 111 area). After the existing trace template line:
   ```html
   {{range .SubScores}}{{if .HasTrace}}<template id="trace-{{.Key}}">{{.TraceHTML}}</template>{{end}}{{end}}
   ```
   Add:
   ```html
   {{range .SubScores}}{{if .HasPrompt}}<template id="prompt-{{.Key}}">{{.PromptHTML}}</template>{{end}}{{end}}
   ```

3. **Add prompt details fallback** in the metric-details-row (around line 100-105), after the existing trace fallback `</details>`:
   ```html
   {{if .HasPrompt}}
   <details class="trace-fallback">
       <summary>Improvement Prompt</summary>
       <div class="trace-fallback-content">{{.PromptHTML}}</div>
   </details>
   {{end}}
   ```

4. **Add copyPromptText JavaScript function** in the second `<script>` block (the one with modal functions, around line 201). Add BEFORE the closing `</script>` tag, after the `closeModal()` function and modal event listeners:

   ```javascript
   // Clipboard copy with fallback chain for improvement prompts
   function copyPromptText(buttonEl) {
       var codeEl = buttonEl.closest('.prompt-copy-container').querySelector('code');
       var text = codeEl.textContent;

       if (navigator.clipboard && navigator.clipboard.writeText) {
           navigator.clipboard.writeText(text).then(function() {
               showCopied(buttonEl);
           }).catch(function() {
               fallbackCopy(text, buttonEl, codeEl);
           });
       } else {
           fallbackCopy(text, buttonEl, codeEl);
       }
   }

   function fallbackCopy(text, buttonEl, codeEl) {
       var textarea = document.createElement('textarea');
       textarea.value = text;
       textarea.style.position = 'fixed';
       textarea.style.opacity = '0';
       document.body.appendChild(textarea);
       textarea.select();
       var ok = false;
       try { ok = document.execCommand('copy'); } catch(e) {}
       document.body.removeChild(textarea);
       if (ok) {
           showCopied(buttonEl);
       } else {
           // Last resort: make pre selectable
           var pre = codeEl.parentElement;
           pre.classList.add('prompt-select-fallback');
           buttonEl.textContent = 'Select All & Copy';
           buttonEl.onclick = function() {
               var range = document.createRange();
               range.selectNodeContents(pre);
               window.getSelection().removeAllRanges();
               window.getSelection().addRange(range);
           };
       }
   }

   function showCopied(btn) {
       var orig = btn.textContent;
       btn.textContent = 'Copied!';
       setTimeout(function() { btn.textContent = orig; }, 1500);
   }
   ```

**In `internal/output/templates/styles.css`:**

5. Add prompt-specific styles at the end of the file:

   ```css
   /* Improvement Prompt Styles */
   .prompt-copy-container {
     position: relative;
   }

   .prompt-copy-container pre {
     background: var(--color-surface);
     border: 1px solid var(--color-border);
     border-radius: 6px;
     padding: 1rem;
     padding-top: 2.5rem;
     overflow-x: auto;
     white-space: pre-wrap;
     word-wrap: break-word;
     font-size: 0.85rem;
     line-height: 1.5;
     max-height: 60vh;
     overflow-y: auto;
   }

   .prompt-copy-container .trace-copy-btn {
     position: absolute;
     top: 0.5rem;
     right: 0.5rem;
     z-index: 1;
   }

   .prompt-select-fallback {
     user-select: all;
     cursor: text;
   }

   .prompt-btn {
     background-color: #6366f1;
   }

   .prompt-btn:hover {
     background-color: #4f46e5;
   }
   ```

   The `.prompt-btn` styles give the Improve button a distinct indigo color vs the default trace button color, making it visually distinguishable.
  </action>
  <verify>
  Run `go build ./...` -- must compile.
  Run `go test ./internal/output/...` -- all tests pass.
  Generate a test report: `go run . scan internal/analyzer --output-html /tmp/test-prompt.html`
  Open `/tmp/test-prompt.html` in a browser and verify:
  - Improve buttons appear next to View Trace buttons
  - Clicking Improve opens a modal with the 4-section prompt
  - Copy button works (test on both localhost and file:// if possible)
  - No-JS fallback: details element shows prompt content
  </verify>
  <done>
  Every metric row with score below 9.0 has an "Improve" button. Clicking it opens the modal with a structured prompt containing current score, target score, evidence files, and build/test commands. Copy button uses three-tier fallback (Clipboard API, execCommand, select-all). Progressive enhancement details fallback works without JS.
  </done>
</task>

</tasks>

<verification>
- `go build ./...` compiles
- `go test ./...` passes (no regressions)
- `go run . scan internal/analyzer --output-html /tmp/test-prompt.html` generates report with Improve buttons
- HTML report stays under 500KB (existing size budget)
- Improve buttons open modals with structured prompts
- Copy functionality works
</verification>

<success_criteria>
- Every metric row in HTML report has an "Improve" button (for metrics below score 9.0)
- Modal shows 4-section prompt with interpolated project data
- Copy button works on HTTPS and file:// via fallback chain
- Progressive enhancement: prompt visible in details fallback without JS
- All 7 categories have prompts (C1-C7)
- Report size stays under 500KB budget
</success_criteria>

<output>
After completion, create `.planning/phases/33-improvement-prompt-modals/33-02-SUMMARY.md`
</output>
