<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="ars-report-version" content="1.0">
    <title>ARS Report: {{.ProjectName}}</title>
    <style>{{.InlineCSS}}</style>
    <noscript><style>.ars-modal-trigger { display: none; }</style></noscript>
</head>
<body>
    <script>document.body.classList.add('js-enabled');</script>
    <header>
        <h1>Agent Readiness Score</h1>
        <p class="project-name">{{.ProjectName}}</p>
        <div class="composite-score">
            <span class="score score-{{.TierClass}}">{{printf "%.1f" .Composite}}</span>
            <span class="tier tier-{{.TierClass}}">{{.Tier}}</span>
        </div>
        <!-- Tier Legend -->
        <div class="tier-legend">
            <div class="tier-legend-item">
                <div class="tier-legend-badge tier-ready">Ready</div>
                <div class="tier-legend-threshold">≥ 8.0</div>
            </div>
            <div class="tier-legend-item">
                <div class="tier-legend-badge tier-assisted">Assisted</div>
                <div class="tier-legend-threshold">≥ 6.0</div>
            </div>
            <div class="tier-legend-item">
                <div class="tier-legend-badge tier-limited">Limited</div>
                <div class="tier-legend-threshold">≥ 4.0</div>
            </div>
            <div class="tier-legend-item">
                <div class="tier-legend-badge tier-hostile">Hostile</div>
                <div class="tier-legend-threshold">< 4.0</div>
            </div>
        </div>
        <p class="generated-at">Generated: {{.GeneratedAt}}</p>
    </header>

    <section class="radar-chart">
        {{.RadarChartSVG}}
    </section>

    {{if .BadgeURL}}
    <section class="badge-section">
        <h2>README Badge</h2>
        <p>Add this badge to your README to show your project's agent readiness score:</p>
        <div class="badge-preview">
            <img src="{{.BadgeURL}}" alt="ARS Badge">
        </div>
        <div class="badge-code">
            <code id="badge-markdown">{{.BadgeMarkdown}}</code>
            <button onclick="navigator.clipboard.writeText(document.getElementById('badge-markdown').textContent)">Copy</button>
        </div>
    </section>
    {{end}}

    <section class="categories">
        <div class="expand-controls">
            <button onclick="document.querySelectorAll('.metric-row').forEach(r => { r.classList.add('expanded'); r.nextElementSibling.style.display = 'table-row'; }); document.querySelectorAll('.category-citations').forEach(c => { c.classList.add('references-expanded'); const list = c.querySelector('.references-list'); if (list) list.style.display = 'block'; });">Expand All</button>
            <button onclick="document.querySelectorAll('.metric-row').forEach(r => { r.classList.remove('expanded'); r.nextElementSibling.style.display = 'none'; }); document.querySelectorAll('.category-citations').forEach(c => { c.classList.remove('references-expanded'); const list = c.querySelector('.references-list'); if (list) list.style.display = 'none'; });">Collapse All</button>
        </div>
        {{range .Categories}}
        <div class="category">
            <h2>{{.DisplayName}} <span class="cat-score score-{{.ScoreClass}}">{{printf "%.1f" .Score}}/10</span></h2>
            <table class="metric-table">
                <thead>
                    <tr>
                        <th></th>
                        <th>Metric</th>
                        <th>Value</th>
                        <th>Score</th>
                        <th>Weight</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    {{range .SubScores}}
                    <tr class="metric-row{{if .ShouldExpand}} expanded{{end}}" data-metric="{{.Key}}">
                        <td class="chevron-cell">
                            <span class="chevron"></span>
                        </td>
                        <td class="metric-name-cell">{{.DisplayName}}</td>
                        <td>{{.FormattedValue}}</td>
                        <td class="score-cell score-{{.ScoreClass}}">{{printf "%.1f" .Score}}</td>
                        <td>{{printf "%.0f" .WeightPct}}%</td>
                        <td class="trace-cell">{{if .HasTrace}}<button class="ars-modal-trigger" onclick="openModal('{{.DisplayName}} Trace', document.getElementById('trace-{{.Key}}').innerHTML)">View Trace</button>{{end}}</td>
                    </tr>
                    <tr class="metric-details-row" data-for="{{.Key}}"{{if not .ShouldExpand}} style="display: none;"{{end}}>
                        <td></td>
                        <td colspan="5" class="metric-details-content">
                            {{if .BriefDescription}}
                            <div class="metric-brief">{{.BriefDescription}}</div>
                            {{end}}
                            {{if .DetailedDescription}}
                            <div class="metric-detailed">{{.DetailedDescription}}</div>
                            {{end}}
                            {{if .HasTrace}}
                            <details class="trace-fallback">
                                <summary>Scoring Trace</summary>
                                <div class="trace-fallback-content">{{.TraceHTML}}</div>
                            </details>
                            {{end}}
                        </td>
                    </tr>
                    {{end}}
                </tbody>
            </table>
            {{range .SubScores}}{{if .HasTrace}}<template id="trace-{{.Key}}">{{.TraceHTML}}</template>{{end}}{{end}}
            {{if .ImpactDescription}}<p class="impact">{{.ImpactDescription}}</p>{{end}}
            {{if .Citations}}
            <div class="category-citations">
                <h4 class="references-header">
                    <span class="references-chevron"></span>
                    References
                </h4>
                <ul class="references-list" style="display: none;">
                    {{range .Citations}}
                    <li><a href="{{.URL}}" target="_blank" rel="noopener">{{.Title}}</a> ({{.Authors}}, {{.Year}}) - {{.Description}}</li>
                    {{end}}
                </ul>
            </div>
            {{end}}
        </div>
        {{end}}
    </section>

    {{if .HasTrend}}
    <section class="trends">
        <h2>Score Comparison</h2>
        {{.TrendChartSVG}}
    </section>
    {{end}}

    {{if .Recommendations}}
    <section class="recommendations">
        <h2>Top Recommendations</h2>
        {{range .Recommendations}}
        <div class="recommendation">
            <h3>{{.Rank}}. {{.Summary}}</h3>
            <p><strong>Impact:</strong> +{{printf "%.1f" .ScoreImprovement}} points</p>
            <p><strong>Effort:</strong> {{.Effort}}</p>
            <p><strong>Action:</strong> {{.Action}}</p>
        </div>
        {{end}}
    </section>
    {{end}}

    <footer>
        <p class="footer-note">Generated by ARS v{{.Version}}</p>
    </footer>

    <script>
    // Metric expansion toggle
    document.querySelectorAll('.metric-row').forEach(row => {
        const chevronCell = row.querySelector('.chevron-cell');
        chevronCell.addEventListener('click', () => {
            const detailsRow = row.nextElementSibling;
            const isExpanded = row.classList.contains('expanded');

            if (isExpanded) {
                row.classList.remove('expanded');
                detailsRow.style.display = 'none';
            } else {
                row.classList.add('expanded');
                detailsRow.style.display = 'table-row';
            }
        });
    });

    // References expansion toggle
    document.querySelectorAll('.references-header').forEach(header => {
        header.addEventListener('click', () => {
            const citationsDiv = header.parentElement;
            const referencesList = citationsDiv.querySelector('.references-list');
            const isExpanded = citationsDiv.classList.contains('references-expanded');

            if (isExpanded) {
                citationsDiv.classList.remove('references-expanded');
                referencesList.style.display = 'none';
            } else {
                citationsDiv.classList.add('references-expanded');
                referencesList.style.display = 'block';
            }
        });
    });
    </script>

    <dialog id="ars-modal" class="ars-modal">
      <div class="ars-modal-content">
        <header class="ars-modal-header">
          <h3 class="ars-modal-title"></h3>
          <button class="ars-modal-close" autofocus aria-label="Close">&times;</button>
        </header>
        <div class="ars-modal-body"></div>
      </div>
    </dialog>

    <script>
    // Modal dialog functions
    var arsModal = document.getElementById('ars-modal');
    var arsModalTitle = arsModal.querySelector('.ars-modal-title');
    var arsModalBody = arsModal.querySelector('.ars-modal-body');
    var arsModalCloseBtn = arsModal.querySelector('.ars-modal-close');

    function highlightTraceCode() {
        arsModalBody.querySelectorAll('pre code').forEach(function(block) {
            var html = block.innerHTML;
            // Highlight JSON keys: "key":
            html = html.replace(/(&quot;|")([^"]+?)(&quot;|")\s*:/g, '<span class="trace-json-key">"$2"</span>:');
            // Highlight JSON string values: : "value"
            html = html.replace(/:\s*(&quot;|")([^"]*?)(&quot;|")/g, ': <span class="trace-json-string">"$2"</span>');
            // Highlight numbers after colons
            html = html.replace(/:\s*(\d+\.?\d*)/g, ': <span class="trace-json-number">$1</span>');
            block.innerHTML = html;
        });
    }

    function openModal(title, bodyHTML) {
        arsModalTitle.textContent = title;
        arsModalBody.innerHTML = bodyHTML;
        highlightTraceCode();
        var scrollY = window.scrollY;
        document.body.dataset.scrollY = scrollY;
        document.body.style.position = 'fixed';
        document.body.style.top = -scrollY + 'px';
        document.body.style.left = '0';
        document.body.style.right = '0';
        arsModal.showModal();
    }

    function closeModal() {
        arsModal.close();
    }

    // Close button click
    arsModalCloseBtn.addEventListener('click', function() {
        closeModal();
    });

    // Backdrop click detection
    arsModal.addEventListener('click', function(e) {
        if (e.target === arsModal) {
            closeModal();
        }
    });

    // Restore scroll position on dialog close
    arsModal.addEventListener('close', function() {
        var scrollY = document.body.dataset.scrollY || '0';
        document.body.style.position = '';
        document.body.style.top = '';
        document.body.style.left = '';
        document.body.style.right = '';
        window.scrollTo(0, parseInt(scrollY));
    });
    </script>
</body>
</html>
